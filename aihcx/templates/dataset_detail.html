{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX æ•°æ®é›†è¯¦æƒ…{% endblock %}

{% block header_title %}ğŸ“Š æ•°æ®é›†è¯¦æƒ…{% endblock %}
{% block header_subtitle %}æŸ¥çœ‹æ•°æ®é›†è¯¦ç»†ä¿¡æ¯{% endblock %}

{% block extra_css %}
<style>
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .dataset-card {
        background: var(--panel-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .dataset-card-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .dataset-card-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
    }
    
    .dataset-card-body {
        padding: 24px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .info-item {
        margin-bottom: 16px;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    .info-value {
        font-size: 15px;
        color: var(--text);
        word-break: break-all;
    }
    
    .nav-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 24px;
    }
    
    .nav-tab {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: var(--muted);
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .nav-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    
    .nav-tab:hover:not(.active) {
        color: var(--text);
        background: #f8f9fa;
    }
    
    .tab-content {
        min-height: 300px;
    }
    
    .loading, .error {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
    }
    
    .error {
        color: #dc3545;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    .versions-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel-bg);
    }
    
    .versions-table th {
        background: #f8f9fa;
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    
    .versions-table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    
    .versions-table tr:hover {
        background: #f8f9fa;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background: var(--primary-600);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 24px;
        gap: 8px;
    }
    
    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--border);
        background: var(--panel-bg);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .pagination button:hover:not(:disabled) {
        background: #f8f9fa;
    }
    
    .pagination button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .pagination-info {
        margin: 0 16px;
        color: var(--muted);
        font-size: 14px;
    }
    
    .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 800px;
        height: 100vh;
        background-color: white;
        box-shadow: -2px 0 20px rgba(0,0,0,0.15);
        z-index: 10000;
        display: none;
        flex-direction: column;
        animation: slideIn 0.3s ease-out;
    }
    
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .drawer-header {
        padding: 24px 24px 16px 24px;
        border-bottom: 1px solid var(--border);
        position: relative;
    }
    
    .drawer-header h4 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
    }
    
    .drawer-description {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
    }
    
    .drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .drawer-close:hover {
        background: #f1f3f4;
        color: var(--text);
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(43,109,239,0.12);
    }
    
    .radio-group {
        display: flex;
        gap: 20px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .radio-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .radio-item:hover {
        background: #f8f9fa;
    }
    
    .radio-item input[type="radio"] {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
    }
    
    .radio-label {
        font-size: 14px;
        color: var(--text);
        cursor: pointer;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .checkbox-item input {
        margin-right: 8px;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 32px;
        padding: 20px 20px;
        border-top: 1px solid var(--border);
        position: sticky;
        bottom: 0;
        background: white;
        z-index: 10;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 100px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: white;
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-secondary:hover {
        background: var(--hover);
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-1px);
    }
    
    .copy-btn {
        margin-left: 10px;
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
    }
    
    .target-dataset-info {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }
    
    .target-dataset-info h5 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
    }
    
    .info-row {
        display: flex;
        margin-bottom: 8px;
    }
    
    .info-label {
        font-weight: 500;
        color: var(--muted);
        min-width: 60px;
    }
    
    .info-value {
        color: var(--text);
        font-weight: 500;
    }
    
    .import-method-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .tab-item {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        position: relative;
        background: white;
    }
    
    .tab-item:hover {
        border-color: var(--primary);
        background: #f8f9fa;
    }
    
    .tab-item.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .tab-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ffc107;
        color: #000;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
    
    .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
    }
    
    .toggle-input {
        display: none;
    }
    
    .toggle-slider {
        width: 44px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        margin-right: 12px;
        transition: background 0.3s ease;
    }
    
    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
    }
    
    .toggle-input:checked + .toggle-slider {
        background: var(--primary);
    }
    
    .toggle-input:checked + .toggle-slider::before {
        transform: translateX(20px);
    }
    
    .toggle-description {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.4;
    }
    
    .resource-row {
        display: flex;
        gap: 12px;
    }
    
    .resource-row .form-control {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <div class="page-container">
        <!-- æ“ä½œæ  -->
        <div class="action-bar">
            <a href="/datasets" class="btn-back">
                <i class="fas fa-arrow-left"></i> è¿”å›æ•°æ®é›†åˆ—è¡¨
            </a>

        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> æ•°æ®åŠ è½½ä¸­...
        </div>
        
        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div v-if="error" class="error">
            <i class="fas fa-exclamation-circle"></i> [[ error ]]
        </div>
        
        <!-- æ•°æ®é›†åŸºæœ¬ä¿¡æ¯ -->
        <div v-if="dataset && !loading">
            <div class="dataset-card">
                <div class="dataset-card-header">
                    <h5>[[ dataset.name ]]</h5>
                </div>
                <div class="dataset-card-body">
                    <div class="info-grid">
                        <div>
                            <div class="info-item">
                                <div class="info-label">æ•°æ®é›†ID</div>
                                <div class="info-value">
                                    [[ dataset.id ]]
                                    <button @click="copyDatasetId(dataset.id)" class="btn btn-sm btn-outline-primary copy-btn">å¤åˆ¶</button>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                                <div class="info-value">[[ formatDate(dataset.createdAt) ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æ›´æ–°æ—¶é—´</div>
                                <div class="info-value">[[ formatDate(dataset.updatedAt) ]]</div>
                            </div>
                        </div>
                        <div>
                            <div class="info-item">
                                <div class="info-label">å­˜å‚¨ç±»å‹</div>
                                <div class="info-value">[[ dataset.storageType ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å¯è§èŒƒå›´</div>
                                <div class="info-value">[[ formatVisibility(dataset.visibilityScope) ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æœ€æ–°ç‰ˆæœ¬</div>
                                <div class="info-value">[[ dataset.latestVersion ]]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabå¯¼èˆª -->
        <div class="nav-tabs" v-if="dataset && !loading">
            <div class="nav-tab" :class="{active: activeTab === 'basic'}" @click="switchTab('basic')">
                åŸºæœ¬ä¿¡æ¯
            </div>
            <div class="nav-tab" :class="{active: activeTab === 'versions'}" @click="switchTab('versions')">
                ç‰ˆæœ¬åˆ—è¡¨
            </div>
        </div>
        
        <!-- Tabå†…å®¹ -->
        <div class="tab-content">
            <!-- åŸºæœ¬ä¿¡æ¯Tab -->
            <div v-show="activeTab === 'basic'" v-if="dataset && !loading">
                <div class="dataset-card">
                    <div class="dataset-card-body">
                        <h6>è¯¦ç»†ä¿¡æ¯</h6>
                        <div class="info-grid">
                            <div>
                                <div class="info-item">
                                    <div class="info-label">æ‰€æœ‰è€…</div>
                                    <div class="info-value">[[ dataset.ownerName ]] ([[ dataset.owner ]])</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">å¯¼å…¥æ ¼å¼</div>
                                    <div class="info-value">[[ dataset.importFormat ]]</div>
                                </div>
                            </div>
                            <div>
                                <div class="info-item">
                                    <div class="info-label">å­˜å‚¨å®ä¾‹</div>
                                    <div class="info-value">[[ dataset.storageInstance ]]</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">è¯·æ±‚ID</div>
                                    <div class="info-value">[[ dataset.requestId ]]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç‰ˆæœ¬åˆ—è¡¨Tab -->
            <div v-show="activeTab === 'versions'">
                <div class="mt-3">
                    <!-- ç‰ˆæœ¬åˆ—è¡¨åŠ è½½çŠ¶æ€ -->
                    <div v-if="versionsLoading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> ç‰ˆæœ¬åˆ—è¡¨åŠ è½½ä¸­...
                    </div>
                    
                    <!-- ç‰ˆæœ¬åˆ—è¡¨é”™è¯¯ä¿¡æ¯ -->
                    <div v-if="versionsError" class="error">
                        <i class="fas fa-exclamation-circle"></i> [[ versionsError ]]
                    </div>
                    
                    <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
                    <div v-if="!versionsLoading && !versionsError && versions.length > 0">
                        <div class="table-container">
                            <table class="versions-table">
                                <thead>
                                    <tr>
                                        <th>ç‰ˆæœ¬</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>åˆ›å»ºè€…</th>
                                        <th>å­˜å‚¨è·¯å¾„</th>
                                        <th>æŒ‚è½½è·¯å¾„</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="version in versions" :key="version.id">
                                        <td>[[ version.version ]]</td>
                                        <td>[[ formatDate(version.createdAt) ]]</td>
                                        <td>[[ version.createUserName ]]</td>
                                        <td>[[ version.storagePath ]]</td>
                                        <td>[[ version.mountPath ]]</td>
                                        <td>
                                            <button @click="showImportDrawer(version)" class="btn-primary">å¯¼å…¥æ•°æ®</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- åˆ†é¡µ -->
                        <div class="pagination">
                            <button @click="prevPage" :disabled="currentPage === 1">
                                <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                            </button>
                            <span class="pagination-info">
                                ç¬¬ [[ currentPage ]] é¡µï¼Œå…± [[ totalPages ]] é¡µ
                            </span>
                            <button @click="nextPage" :disabled="currentPage === totalPages">
                                ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ— ç‰ˆæœ¬æ•°æ® -->
                    <div v-if="!versionsLoading && !versionsError && versions.length === 0" class="loading">
                        æš‚æ— ç‰ˆæœ¬æ•°æ®
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯¼å…¥æ•°æ®æŠ½å±‰é®ç½© -->
<div id="drawer-overlay" class="drawer-overlay" onclick="closeDrawer()"></div>

<!-- å¯¼å…¥æ•°æ®æŠ½å±‰ -->
<div id="drawer" class="drawer">
    <div class="drawer-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h4>å¯¼å…¥æ•°æ®</h4>
                <p class="drawer-description">å°†æ•°æ®å¯¼å…¥åˆ°å½“å‰æ•°æ®é›†,åç»­å¯ä»¥åœ¨ç™¾èˆ¸è´Ÿè½½ä¸­æŒ‚è½½ä½¿ç”¨</p>
            </div>
            <button class="drawer-close" onclick="closeDrawer()" style="margin-left: 20px; flex-shrink: 0;">&times;</button>
        </div>
    </div>
    
    <div class="drawer-content">
        <!-- ç›®æ ‡æ•°æ®é›†ä¿¡æ¯ -->
        <div class="target-dataset-info">
            <h5>ç›®æ ‡æ•°æ®é›†ä¿¡æ¯</h5>
            <div class="info-row">
                <span class="info-label">åç§°:</span>
                <span class="info-value" id="dataset-name">åŠ è½½ä¸­...</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç‰ˆæœ¬:</span>
                <span class="info-value" id="dataset-version">å½“å‰ç‰ˆæœ¬</span>
            </div>
        </div>
        
        <!-- å¯¼å…¥æ–¹å¼é€‰æ‹© -->
        <div class="form-group">
            <label class="form-label">å¯¼å…¥æ–¹å¼</label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="existing" name="importMethod">
                    <span class="radio-label">å·²æœ‰æ•°æ®é›†</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="public" name="importMethod">
                    <span class="radio-label">å…¬å…±æ•°æ®é›†</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="object" name="importMethod">
                    <span class="radio-label">å¯¹è±¡å­˜å‚¨</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="huggingface" name="importMethod">
                    <span class="radio-label">HuggingFace</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="custom" name="importMethod">
                    <span class="radio-label">è‡ªå®šä¹‰ä¸‹è½½</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="upload" name="importMethod">
                    <span class="radio-label">ä¸Šä¼ æ–‡ä»¶</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="tool" name="importMethod">
                    <span class="radio-label">å·¥å…·ä¸Šä¼ </span>
                </label>
            </div>
        </div>
        
        <!-- æºæ•°æ®é›†é…ç½® -->
        <div v-if="importMethod === 'existing'" class="form-group">
            <label class="form-label required">æºæ•°æ®é›†</label>
            <select v-model="formData.sourceDataset" @change="onSourceDatasetChange" class="form-control">
                <option value="">è¯·é€‰æ‹©æºæ•°æ®é›†</option>
                <option v-for="dataset in availableDatasets" :key="dataset.id" :value="dataset.id">
                    [[ dataset.name ]]
                </option>
            </select>
        </div>
        
        <div v-if="importMethod === 'existing'" class="form-group">
            <label class="form-label required">æ•°æ®ç‰ˆæœ¬</label>
            <select v-model="formData.datasetVersion" class="form-control">
                <option value="">è¯·é€‰æ‹©æ•°æ®ç‰ˆæœ¬</option>
                <option v-for="version in datasetVersions" :key="version.id" :value="version.id">
                    [[ version.version ]]
                </option>
            </select>
        </div>
        
        <!-- æ¸…ç©ºæ•°æ®é€‰é¡¹ -->
        <div class="form-group">
            <div class="toggle-group">
                <label class="toggle-label">
                    <input type="checkbox" v-model="formData.cleanData" class="toggle-input">
                    <span class="toggle-slider"></span>
                    æ¸…ç©ºæ•°æ®
                </label>
                <p class="toggle-description">å¼€å¯æ¸…ç©ºæ•°æ®ä¼šåœ¨å¯¼å…¥å¼€å§‹æ—¶å…ˆåˆ é™¤å½“å‰æ•°æ®é›†ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶</p>
            </div>
        </div>
        
        <!-- åŒåä¿ç•™ç­–ç•¥ -->
        <div class="form-group">
            <label class="form-label required">åŒåä¿ç•™ç­–ç•¥</label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" value="target" v-model="formData.nameStrategy" name="nameStrategy">
                    <span class="radio-label">ä¿ç•™ç›®çš„æ–‡ä»¶</span>
                </label>
                <label class="radio-item">
                    <input type="radio" value="source" v-model="formData.nameStrategy" name="nameStrategy">
                    <span class="radio-label">ä¿ç•™æºæ–‡ä»¶</span>
                </label>
            </div>
        </div>
        
        <!-- èµ„æºæ± /é˜Ÿåˆ— -->
        <div class="form-group">
            <label class="form-label required">èµ„æºæ± /é˜Ÿåˆ—</label>
            <div class="resource-row">
                <select v-model="formData.resourcePool" class="form-control">
                    <option value="resourceABC">èµ„æºæ± ABC</option>
                    <option value="resourceDEF">èµ„æºæ± DEF</option>
                </select>
                <select v-model="formData.queue" class="form-control">
                    <option value="queue01">é˜Ÿåˆ—01</option>
                    <option value="queue02">é˜Ÿåˆ—02</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" @click="submitImportForm">ç¡®å®š</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ç®€å•çš„æŠ½å±‰æ§åˆ¶å‡½æ•°

function closeDrawer() {
    document.getElementById('drawer').style.display = 'none';
    document.getElementById('drawer-overlay').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// ä»Jinja2æ¨¡æ¿è·å–æ•°æ®é›†ID
const DATASET_ID = '{{ dataset_id }}';

const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      dataset: null,
      loading: false,
      error: null,
      datasetId: DATASET_ID,
      activeTab: 'basic', // é»˜è®¤æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯tab
      
      // ç‰ˆæœ¬åˆ—è¡¨ç›¸å…³æ•°æ®
      versions: [],
      versionsLoading: false,
      versionsError: null,
      currentPage: 1,
      pageSize: 10,
      totalVersions: 0,
      
      // å¯¼å…¥æ•°æ®ç›¸å…³æ•°æ®
      importMethod: 'existing', // é»˜è®¤é€‰ä¸­å·²æœ‰æ•°æ®é›†
      availableDatasets: [], // å¯é€‰æ•°æ®é›†åˆ—è¡¨
      datasetVersions: [], // æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨
      formData: {
        sourceDataset: '',
        datasetVersion: '',
        cleanData: false,
        nameStrategy: 'target', // é»˜è®¤é€‰ä¸­ä¿ç•™ç›®çš„æ–‡ä»¶
        resourcePool: '',
        queue: ''
      }

    }
  },
  computed: {
    totalPages() {
      return Math.ceil(this.totalVersions / this.pageSize);
    }
  },
  methods: {
    async showImportDrawer(version) {
      // ç¡®ä¿é»˜è®¤é€‰ä¸­å·²æœ‰æ•°æ®é›†
      this.importMethod = 'existing';
      
      // ç¡®ä¿é»˜è®¤é€‰ä¸­ä¿ç•™ç›®çš„æ–‡ä»¶
      this.formData.nameStrategy = 'target';
      
      console.log('è®¾ç½®é»˜è®¤å€¼ - importMethod:', this.importMethod, 'nameStrategy:', this.formData.nameStrategy);
      
      // åŠ è½½å¯é€‰æ•°æ®é›†åˆ—è¡¨
      await this.loadAvailableDatasets();
      
      console.log('æ•°æ®é›†åˆ—è¡¨åŠ è½½å®Œæˆï¼Œæ•°é‡:', this.availableDatasets.length);
      console.log('æ•°æ®é›†åˆ—è¡¨å†…å®¹:', this.availableDatasets);
      
      // å¼ºåˆ¶Vue.jsæ›´æ–°
      this.$forceUpdate();
      
      // ä½¿ç”¨$nextTickç¡®ä¿Vue.jså“åº”å¼æ›´æ–°å®Œæˆåå†æ˜¾ç¤ºæŠ½å±‰
      this.$nextTick(() => {
        // æ›´æ–°æ•°æ®é›†ä¿¡æ¯
        const datasetName = document.querySelector('h5') ? document.querySelector('h5').textContent : 'æ•°æ®é›†';
        document.getElementById('dataset-name').textContent = datasetName;
        
        // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        const versionText = version && version.version ? version.version : 'å½“å‰ç‰ˆæœ¬';
        document.getElementById('dataset-version').textContent = versionText;
        
        // æ˜¾ç¤ºæŠ½å±‰
        document.getElementById('drawer').style.display = 'flex';
        document.getElementById('drawer-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // å†æ¬¡ç¡®è®¤é»˜è®¤å€¼è®¾ç½®
        console.log('æŠ½å±‰æ˜¾ç¤ºå - importMethod:', this.importMethod, 'nameStrategy:', this.formData.nameStrategy);
        console.log('æŠ½å±‰æ˜¾ç¤ºå - availableDatasets:', this.availableDatasets);
        
        // æ£€æŸ¥DOMä¸­çš„å•é€‰æŒ‰é’®çŠ¶æ€
        const existingRadio = document.querySelector('input[value="existing"]');
        const targetRadio = document.querySelector('input[value="target"]');
        console.log('DOMæ£€æŸ¥ - existing radio checked:', existingRadio ? existingRadio.checked : 'not found');
        console.log('DOMæ£€æŸ¥ - target radio checked:', targetRadio ? targetRadio.checked : 'not found');
        
        // æ£€æŸ¥æºæ•°æ®é›†ä¸‹æ‹‰æ¡†
        const sourceDatasetSelect = document.querySelector('select[v-model="formData.sourceDataset"]');
        console.log('æºæ•°æ®é›†ä¸‹æ‹‰æ¡†:', sourceDatasetSelect);
        if (sourceDatasetSelect) {
          console.log('ä¸‹æ‹‰æ¡†é€‰é¡¹æ•°é‡:', sourceDatasetSelect.options.length);
          for (let i = 0; i < sourceDatasetSelect.options.length; i++) {
            console.log(`é€‰é¡¹ ${i}:`, sourceDatasetSelect.options[i].text, sourceDatasetSelect.options[i].value);
          }
        }
      });
    },
    onSourceDatasetChange() {
      // å½“é€‰æ‹©æºæ•°æ®é›†æ—¶ï¼ŒåŠ è½½å¯¹åº”çš„ç‰ˆæœ¬åˆ—è¡¨
      if (this.formData.sourceDataset) {
        this.loadDatasetVersions(this.formData.sourceDataset);
        // æ¸…ç©ºä¹‹å‰é€‰æ‹©çš„ç‰ˆæœ¬
        this.formData.datasetVersion = '';
      } else {
        this.datasetVersions = [];
        this.formData.datasetVersion = '';
      }
    },
    async loadAvailableDatasets() {
      try {
        console.log('è·å–æ•°æ®é›†åˆ—è¡¨...');
        const response = await axios.get('/api?action=DescribeDatasets');
        console.log('æ•°æ®é›†åˆ—è¡¨APIå“åº”:', response.data);
        
        if (response.data && response.data.Datasets) {
          this.availableDatasets = response.data.Datasets;
          console.log('æ•°æ®é›†åˆ—è¡¨åŠ è½½æˆåŠŸ:', this.availableDatasets);
        } else if (response.data && response.data.datasets) {
          this.availableDatasets = response.data.datasets;
          console.log('æ•°æ®é›†åˆ—è¡¨åŠ è½½æˆåŠŸ:', this.availableDatasets);
        } else {
          console.log('æ•°æ®é›†åˆ—è¡¨ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
          this.availableDatasets = [];
        }
      } catch (error) {
        console.error('è·å–æ•°æ®é›†åˆ—è¡¨å¤±è´¥:', error);
        this.availableDatasets = [];
      }
    },
    async loadDatasetVersions(datasetId) {
      if (!datasetId) {
        this.datasetVersions = [];
        return;
      }
      
      try {
        console.log('è·å–æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨:', datasetId);
        const response = await axios.get('/api?action=DescribeDatasetVersions&datasetId=' + encodeURIComponent(datasetId) + '&pageNumber=1&pageSize=100');
        console.log('æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨APIå“åº”:', response.data);
        
        if (response.data && response.data.Versions) {
          this.datasetVersions = response.data.Versions;
          console.log('æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨åŠ è½½æˆåŠŸ:', this.datasetVersions);
        } else if (response.data && response.data.versions) {
          this.datasetVersions = response.data.versions;
          console.log('æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨åŠ è½½æˆåŠŸ:', this.datasetVersions);
        } else {
          console.log('æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
          this.datasetVersions = [];
        }
      } catch (error) {
        console.error('è·å–æ•°æ®é›†ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥:', error);
        this.datasetVersions = [];
      }
    },
    async loadDataset() {
      console.log('loadDataset called for ID:', this.datasetId);
      this.loading = true;
      this.error = null;
      
      try {
        console.log('Making API request...');
        const response = await axios.get('/api?action=DescribeDataset&datasetId=' + encodeURIComponent(this.datasetId));
        console.log('API response received:', response.data);
        const data = response.data;
        
        if (data.error) {
          this.error = data.error;
          return;
        }
        
        // æ•°æ®é›†è¯¦æƒ…ç›´æ¥åœ¨dataä¸­ï¼Œè€Œä¸æ˜¯åœ¨data.datasetæˆ–data.Datasetä¸­
        this.dataset = data;
        console.log('Dataset loaded:', this.dataset);
        console.log('Dataset name:', this.dataset ? this.dataset.name : 'undefined');
        console.log('Dataset ID:', this.dataset ? this.dataset.id : 'undefined');
      } catch (err) {
        console.error('Error loading dataset:', err);
        this.error = 'åŠ è½½æ•°æ®é›†è¯¦æƒ…å¤±è´¥: ' + err.message;
      } finally {
        this.loading = false;
      }
    },
    async loadVersions() {
      console.log('loadVersions called for ID:', this.datasetId);
      this.versionsLoading = true;
      this.versionsError = null;
      
      try {
        console.log('Making versions API request...');
        const response = await axios.get('/api?action=DescribeDatasetVersions&datasetId=' + encodeURIComponent(this.datasetId) + '&pageNumber=' + this.currentPage + '&pageSize=' + this.pageSize);
        console.log('Versions API response received:', response.data);
        const data = response.data;
        
        if (data.error) {
          this.versionsError = data.error;
          return;
        }
        
        // ç‰ˆæœ¬åˆ—è¡¨åœ¨data.versionsä¸­ï¼Œæ€»æ•°åœ¨data.totalCountä¸­
        this.versions = data.versions || data.Versions || [];
        this.totalVersions = data.totalCount || data.TotalCount || 0;
        console.log('Versions loaded:', this.versions);
      } catch (err) {
        console.error('Error loading versions:', err);
        this.versionsError = 'åŠ è½½ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥: ' + err.message;
      } finally {
        this.versionsLoading = false;
      }
    },
    switchTab(tabName) {
      this.activeTab = tabName;
      // å¦‚æœåˆ‡æ¢åˆ°ç‰ˆæœ¬åˆ—è¡¨tabä¸”ç‰ˆæœ¬åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
      if (tabName === 'versions' && this.versions.length === 0 && !this.versionsError) {
        this.loadVersions();
      }
    },
    prevPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.loadVersions();
      }
    },
    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++;
        this.loadVersions();
      }
    },
    // æäº¤å¯¼å…¥è¡¨å•
    async submitImportForm() {
        console.log('submitImportForm called');
      // è¡¨å•éªŒè¯
      if (this.importMethod === 'existing' && (!this.formData.sourceDataset || !this.formData.datasetVersion)) {
        alert('è¯·é€‰æ‹©æºæ•°æ®é›†å’Œæ•°æ®ç‰ˆæœ¬');
        return;
      }
      
      if (!this.formData.nameStrategy) {
        alert('è¯·é€‰æ‹©åŒåä¿ç•™ç­–ç•¥');
        return;
      }
      
      if (!this.formData.resourcePool || !this.formData.queue) {
        alert('è¯·é€‰æ‹©èµ„æºæ± å’Œé˜Ÿåˆ—');
        return;
      }
      
      // æ„å»ºå¯¼å…¥æ•°æ®è¯·æ±‚å‚æ•°
      const requestParams = {
        datasetId: this.datasetId,
        versionId: this.currentVersion ? this.currentVersion.id : null,
        importMethod: this.importMethod,
        sourceDataset: this.formData.sourceDataset,
        datasetVersion: this.formData.datasetVersion,
        cleanData: this.formData.cleanData,
        nameStrategy: this.formData.nameStrategy,
        resourcePool: this.formData.resourcePool,
        queue: this.formData.queue
      };
      
      console.log('å¯¼å…¥æ•°æ®è¯·æ±‚å‚æ•°:', requestParams);
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('.form-actions .btn-primary');
        if (submitBtn) {
          submitBtn.textContent = 'æäº¤ä¸­...';
          submitBtn.disabled = true;
        }
        
        // è°ƒç”¨å¯¼å…¥æ•°æ®API
        const response = await axios.post('/api?action=ImportDatasetData', requestParams);
        console.log('å¯¼å…¥æ•°æ®APIå“åº”:', response.data);
        
        if (response.data.error) {
          alert('å¯¼å…¥æ•°æ®å¤±è´¥: ' + response.data.error);
        } else {
          alert('å¯¼å…¥æ•°æ®è¯·æ±‚å·²æˆåŠŸæäº¤ï¼');
          // å…³é—­æŠ½å±‰
          this.closeDrawer();
        }
      } catch (error) {
        console.error('å¯¼å…¥æ•°æ®APIè°ƒç”¨å¤±è´¥:', error);
        alert('å¯¼å…¥æ•°æ®å¤±è´¥: ' + (error.response?.data?.error || error.message || 'æœªçŸ¥é”™è¯¯'));
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('.form-actions .btn-primary');
        if (submitBtn) {
          submitBtn.textContent = 'ç¡®å®š';
          submitBtn.disabled = false;
        }
      }
    },
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    },
    formatVisibility(visibilityScope) {
      if (!visibilityScope) return 'N/A';
      const visibilityMap = {
        'ALL_PEOPLE': 'æ‰€æœ‰äººå¯è§',
        'USER_GROUP': 'ç”¨æˆ·ç»„å¯è§',
        'ONLY_OWNER': 'ä»…æ‰€æœ‰è€…å¯è§'
      };
      return visibilityMap[visibilityScope] || visibilityScope;
    },
    copyDatasetId(id) {
      if (!id) return;
      
      // ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„Clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(id).then(() => {
          this.showCopySuccess();
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          this.fallbackCopy(id);
        });
      } else {
        // é™çº§æ–¹æ¡ˆ
        this.fallbackCopy(id);
      }
    },
    fallbackCopy(text) {
      // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        this.showCopySuccess();
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
      }
      
      document.body.removeChild(textArea);
    },
    showCopySuccess() {
      // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
      const toast = document.createElement('div');
      toast.textContent = 'æ•°æ®é›†IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #52c41a;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(toast);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }
  },
  mounted() {
    // ç¡®ä¿æŠ½å±‰åˆå§‹çŠ¶æ€æ˜¯éšè—çš„
    this.drawerVisible = false;
    this.loadDataset();
  }
}).mount('#app');
</script>
{% endblock %}