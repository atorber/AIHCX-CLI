{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX Êï∞ÊçÆÈõÜËØ¶ÊÉÖ{% endblock %}

{% block header_title %}üìä Êï∞ÊçÆÈõÜËØ¶ÊÉÖ{% endblock %}
{% block header_subtitle %}Êü•ÁúãÊï∞ÊçÆÈõÜËØ¶ÁªÜ‰ø°ÊÅØ{% endblock %}

{% block extra_css %}
<style>
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .dataset-card {
        background: var(--panel-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .dataset-card-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .dataset-card-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
    }
    
    .dataset-card-body {
        padding: 24px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .info-item {
        margin-bottom: 16px;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    .info-value {
        font-size: 15px;
        color: var(--text);
        word-break: break-all;
    }
    
    .nav-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 24px;
    }
    
    .nav-tab {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        color: var(--muted);
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .nav-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    
    .nav-tab:hover:not(.active) {
        color: var(--text);
        background: #f8f9fa;
    }
    
    .tab-content {
        min-height: 300px;
    }
    
    .loading, .error {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
    }
    
    .error {
        color: #dc3545;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    
    .versions-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--panel-bg);
    }
    
    .versions-table th {
        background: #f8f9fa;
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    
    .versions-table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    
    .versions-table tr:hover {
        background: #f8f9fa;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background: var(--primary-600);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 24px;
        gap: 8px;
    }
    
    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--border);
        background: var(--panel-bg);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .pagination button:hover:not(:disabled) {
        background: #f8f9fa;
    }
    
    .pagination button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .pagination-info {
        margin: 0 16px;
        color: var(--muted);
        font-size: 14px;
    }
    
    .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 800px;
        height: 100vh;
        background-color: white;
        box-shadow: -2px 0 20px rgba(0,0,0,0.15);
        z-index: 10000;
        display: none;
        flex-direction: column;
        animation: slideIn 0.3s ease-out;
    }
    
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .drawer-header {
        padding: 24px 24px 16px 24px;
        border-bottom: 1px solid var(--border);
        position: relative;
    }
    
    .drawer-header h4 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
    }
    
    .drawer-description {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
    }
    
    .drawer-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .drawer-close:hover {
        background: #f1f3f4;
        color: var(--text);
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(43,109,239,0.12);
    }
    
    .radio-group {
        display: flex;
        gap: 20px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .radio-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .radio-item:hover {
        background: #f8f9fa;
    }
    
    .radio-item input[type="radio"] {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
    }
    
    .radio-label {
        font-size: 14px;
        color: var(--text);
        cursor: pointer;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .checkbox-item input {
        margin-right: 8px;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 32px;
        padding: 20px 20px;
        border-top: 1px solid var(--border);
        position: sticky;
        bottom: 0;
        background: white;
        z-index: 10;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 100px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: white;
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-secondary:hover {
        background: var(--hover);
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-1px);
    }
    
    .copy-btn {
        margin-left: 10px;
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .drawer-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
    }
    
    .target-dataset-info {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }
    
    .target-dataset-info h5 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
    }
    
    .info-row {
        display: flex;
        margin-bottom: 8px;
    }
    
    .info-label {
        font-weight: 500;
        color: var(--muted);
        min-width: 60px;
    }
    
    .info-value {
        color: var(--text);
        font-weight: 500;
    }
    
    .import-method-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .tab-item {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        position: relative;
        background: white;
    }
    
    .tab-item:hover {
        border-color: var(--primary);
        background: #f8f9fa;
    }
    
    .tab-item.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .tab-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ffc107;
        color: #000;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
    
    .toggle-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
    }
    
    .toggle-input {
        display: none;
    }
    
    .toggle-slider {
        width: 44px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        margin-right: 12px;
        transition: background 0.3s ease;
    }
    
    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
    }
    
    .toggle-input:checked + .toggle-slider {
        background: var(--primary);
    }
    
    .toggle-input:checked + .toggle-slider::before {
        transform: translateX(20px);
    }
    
    .toggle-description {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.4;
    }
    
    .resource-row {
        display: flex;
        gap: 12px;
    }
    
    .resource-row .form-control {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <div class="page-container">
        <!-- Êìç‰ΩúÊ†è -->
        <div class="action-bar">
            <a href="/datasets" class="btn-back">
                <i class="fas fa-arrow-left"></i> ËøîÂõûÊï∞ÊçÆÈõÜÂàóË°®
            </a>

        </div>
        
        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Êï∞ÊçÆÂä†ËΩΩ‰∏≠...
        </div>
        
        <!-- ÈîôËØØ‰ø°ÊÅØ -->
        <div v-if="error" class="error">
            <i class="fas fa-exclamation-circle"></i> [[ error ]]
        </div>
        
        <!-- Êï∞ÊçÆÈõÜÂü∫Êú¨‰ø°ÊÅØ -->
        <div v-if="dataset && !loading">
            <div class="dataset-card">
                <div class="dataset-card-header">
                    <h5>[[ dataset.name ]]</h5>
                </div>
                <div class="dataset-card-body">
                    <div class="info-grid">
                        <div>
                            <div class="info-item">
                                <div class="info-label">Êï∞ÊçÆÈõÜID</div>
                                <div class="info-value">
                                    [[ dataset.id ]]
                                    <button @click="copyDatasetId(dataset.id)" class="btn btn-sm btn-outline-primary copy-btn">Â§çÂà∂</button>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ÂàõÂª∫Êó∂Èó¥</div>
                                <div class="info-value">[[ formatDate(dataset.createdAt) ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Êõ¥Êñ∞Êó∂Èó¥</div>
                                <div class="info-value">[[ formatDate(dataset.updatedAt) ]]</div>
                            </div>
                        </div>
                        <div>
                            <div class="info-item">
                                <div class="info-label">Â≠òÂÇ®Á±ªÂûã</div>
                                <div class="info-value">[[ dataset.storageType ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ÂèØËßÅËåÉÂõ¥</div>
                                <div class="info-value">[[ formatVisibility(dataset.visibilityScope) ]]</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ÊúÄÊñ∞ÁâàÊú¨</div>
                                <div class="info-value">[[ dataset.latestVersion ]]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TabÂØºËà™ -->
        <div class="nav-tabs" v-if="dataset && !loading">
            <div class="nav-tab" :class="{active: activeTab === 'basic'}" @click="switchTab('basic')">
                Âü∫Êú¨‰ø°ÊÅØ
            </div>
            <div class="nav-tab" :class="{active: activeTab === 'versions'}" @click="switchTab('versions')">
                ÁâàÊú¨ÂàóË°®
            </div>
        </div>
        
        <!-- TabÂÜÖÂÆπ -->
        <div class="tab-content">
            <!-- Âü∫Êú¨‰ø°ÊÅØTab -->
            <div v-show="activeTab === 'basic'" v-if="dataset && !loading">
                <div class="dataset-card">
                    <div class="dataset-card-body">
                        <h6>ËØ¶ÁªÜ‰ø°ÊÅØ</h6>
                        <div class="info-grid">
                            <div>
                                <div class="info-item">
                                    <div class="info-label">ÊâÄÊúâËÄÖ</div>
                                    <div class="info-value">[[ dataset.ownerName ]] ([[ dataset.owner ]])</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÂØºÂÖ•Ê†ºÂºè</div>
                                    <div class="info-value">[[ dataset.importFormat ]]</div>
                                </div>
                            </div>
                            <div>
                                <div class="info-item">
                                    <div class="info-label">Â≠òÂÇ®ÂÆû‰æã</div>
                                    <div class="info-value">[[ dataset.storageInstance ]]</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ËØ∑Ê±ÇID</div>
                                    <div class="info-value">[[ dataset.requestId ]]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÁâàÊú¨ÂàóË°®Tab -->
            <div v-show="activeTab === 'versions'">
                <div class="mt-3">
                    <!-- ÁâàÊú¨ÂàóË°®Âä†ËΩΩÁä∂ÊÄÅ -->
                    <div v-if="versionsLoading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> ÁâàÊú¨ÂàóË°®Âä†ËΩΩ‰∏≠...
                    </div>
                    
                    <!-- ÁâàÊú¨ÂàóË°®ÈîôËØØ‰ø°ÊÅØ -->
                    <div v-if="versionsError" class="error">
                        <i class="fas fa-exclamation-circle"></i> [[ versionsError ]]
                    </div>
                    
                    <!-- ÁâàÊú¨ÂàóË°® -->
                    <div v-if="!versionsLoading && !versionsError && versions.length > 0">
                        <div class="table-container">
                            <table class="versions-table">
                                <thead>
                                    <tr>
                                        <th>ÁâàÊú¨</th>
                                        <th>ÂàõÂª∫Êó∂Èó¥</th>
                                        <th>ÂàõÂª∫ËÄÖ</th>
                                        <th>Â≠òÂÇ®Ë∑ØÂæÑ</th>
                                        <th>ÊåÇËΩΩË∑ØÂæÑ</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="version in versions" :key="version.id">
                                        <td>[[ version.version ]]</td>
                                        <td>[[ formatDate(version.createdAt) ]]</td>
                                        <td>[[ version.createUserName ]]</td>
                                        <td>[[ version.storagePath ]]</td>
                                        <td>[[ version.mountPath ]]</td>
                                        <td>
                                            <button @click="showImportDrawer(version)" class="btn-primary">ÂØºÂÖ•Êï∞ÊçÆ</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ÂàÜÈ°µ -->
                        <div class="pagination">
                            <button @click="prevPage" :disabled="currentPage === 1">
                                <i class="fas fa-chevron-left"></i> ‰∏ä‰∏ÄÈ°µ
                            </button>
                            <span class="pagination-info">
                                Á¨¨ [[ currentPage ]] È°µÔºåÂÖ± [[ totalPages ]] È°µ
                            </span>
                            <button @click="nextPage" :disabled="currentPage === totalPages">
                                ‰∏ã‰∏ÄÈ°µ <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Êó†ÁâàÊú¨Êï∞ÊçÆ -->
                    <div v-if="!versionsLoading && !versionsError && versions.length === 0" class="loading">
                        ÊöÇÊó†ÁâàÊú¨Êï∞ÊçÆ
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÂØºÂÖ•Êï∞ÊçÆÊäΩÂ±âÈÅÆÁΩ© -->
<div id="drawer-overlay" class="drawer-overlay" onclick="closeDrawer()"></div>

<!-- ÂØºÂÖ•Êï∞ÊçÆÊäΩÂ±â -->
<div id="drawer" class="drawer">
    <div class="drawer-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h4>ÂØºÂÖ•Êï∞ÊçÆ</h4>
                <p class="drawer-description">Â∞ÜÊï∞ÊçÆÂØºÂÖ•Âà∞ÂΩìÂâçÊï∞ÊçÆÈõÜ,ÂêéÁª≠ÂèØ‰ª•Âú®ÁôæËà∏Ë¥üËΩΩ‰∏≠ÊåÇËΩΩ‰ΩøÁî®</p>
            </div>
            <button class="drawer-close" onclick="closeDrawer()" style="margin-left: 20px; flex-shrink: 0;">&times;</button>
        </div>
    </div>
    
    <div class="drawer-content">
        <!-- ÁõÆÊ†áÊï∞ÊçÆÈõÜ‰ø°ÊÅØ -->
        <div class="target-dataset-info">
            <h5>ÁõÆÊ†áÊï∞ÊçÆÈõÜ‰ø°ÊÅØ</h5>
            <div class="info-row">
                <span class="info-label">ÂêçÁß∞:</span>
                <span class="info-value" id="dataset-name">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <div class="info-row">
                <span class="info-label">ÁâàÊú¨:</span>
                <span class="info-value" id="dataset-version">ÂΩìÂâçÁâàÊú¨</span>
            </div>
        </div>
        
        <!-- ÂØºÂÖ•ÊñπÂºèÈÄâÊã© -->
        <div class="form-group">
            <label class="form-label">ÂØºÂÖ•ÊñπÂºè</label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="existing" name="importMethod">
                    <span class="radio-label">Â∑≤ÊúâÊï∞ÊçÆÈõÜ</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="public" name="importMethod">
                    <span class="radio-label">ÂÖ¨ÂÖ±Êï∞ÊçÆÈõÜ</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="object" name="importMethod">
                    <span class="radio-label">ÂØπË±°Â≠òÂÇ®</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="huggingface" name="importMethod">
                    <span class="radio-label">HuggingFace</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="custom" name="importMethod">
                    <span class="radio-label">Ëá™ÂÆö‰πâ‰∏ãËΩΩ</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="upload" name="importMethod">
                    <span class="radio-label">‰∏ä‰º†Êñá‰ª∂</span>
                </label>
                <label class="radio-item">
                    <input type="radio" v-model="importMethod" value="tool" name="importMethod">
                    <span class="radio-label">Â∑•ÂÖ∑‰∏ä‰º†</span>
                </label>
            </div>
        </div>
        
        <!-- Ê∫êÊï∞ÊçÆÈõÜÈÖçÁΩÆ -->
        <div v-if="importMethod === 'existing'" class="form-group">
            <label class="form-label required">Ê∫êÊï∞ÊçÆÈõÜ</label>
            <select v-model="formData.sourceDataset" @change="onSourceDatasetChange" class="form-control">
                <option value="">ËØ∑ÈÄâÊã©Ê∫êÊï∞ÊçÆÈõÜ</option>
                <option v-for="dataset in availableDatasets" :key="dataset.id" :value="dataset.id">
                    [[ dataset.name ]]
                </option>
            </select>
        </div>
        
        <div v-if="importMethod === 'existing'" class="form-group">
            <label class="form-label required">Êï∞ÊçÆÁâàÊú¨</label>
            <select v-model="formData.datasetVersion" class="form-control">
                <option value="">ËØ∑ÈÄâÊã©Êï∞ÊçÆÁâàÊú¨</option>
                <option v-for="version in datasetVersions" :key="version.id" :value="version.id">
                    [[ version.version ]]
                </option>
            </select>
        </div>
        
        <!-- Ê∏ÖÁ©∫Êï∞ÊçÆÈÄâÈ°π -->
        <div class="form-group">
            <div class="toggle-group">
                <label class="toggle-label">
                    <input type="checkbox" v-model="formData.cleanData" class="toggle-input">
                    <span class="toggle-slider"></span>
                    Ê∏ÖÁ©∫Êï∞ÊçÆ
                </label>
                <p class="toggle-description">ÂºÄÂêØÊ∏ÖÁ©∫Êï∞ÊçÆ‰ºöÂú®ÂØºÂÖ•ÂºÄÂßãÊó∂ÂÖàÂà†Èô§ÂΩìÂâçÊï∞ÊçÆÈõÜÁõÆÂΩï‰∏ãÊâÄÊúâÊñá‰ª∂</p>
            </div>
        </div>
        
        <!-- ÂêåÂêç‰øùÁïôÁ≠ñÁï• -->
        <div class="form-group">
            <label class="form-label required">ÂêåÂêç‰øùÁïôÁ≠ñÁï•</label>
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" value="target" v-model="formData.nameStrategy" name="nameStrategy">
                    <span class="radio-label">‰øùÁïôÁõÆÁöÑÊñá‰ª∂</span>
                </label>
                <label class="radio-item">
                    <input type="radio" value="source" v-model="formData.nameStrategy" name="nameStrategy">
                    <span class="radio-label">‰øùÁïôÊ∫êÊñá‰ª∂</span>
                </label>
            </div>
        </div>
        
        <!-- ËµÑÊ∫êÊ±†/ÈòüÂàó -->
        <div class="form-group">
            <label class="form-label required">ËµÑÊ∫êÊ±†/ÈòüÂàó</label>
            <div class="resource-row">
                <select v-model="formData.resourcePool" class="form-control">
                    <option value="resourceABC">ËµÑÊ∫êÊ±†ABC</option>
                    <option value="resourceDEF">ËµÑÊ∫êÊ±†DEF</option>
                </select>
                <select v-model="formData.queue" class="form-control">
                    <option value="queue01">ÈòüÂàó01</option>
                    <option value="queue02">ÈòüÂàó02</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDrawer()">ÂèñÊ∂à</button>
        <button type="button" class="btn btn-primary" @click="submitImportForm">Á°ÆÂÆö</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ÁÆÄÂçïÁöÑÊäΩÂ±âÊéßÂà∂ÂáΩÊï∞

function closeDrawer() {
    document.getElementById('drawer').style.display = 'none';
    document.getElementById('drawer-overlay').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// ‰ªéJinja2Ê®°ÊùøËé∑ÂèñÊï∞ÊçÆÈõÜID
const DATASET_ID = '{{ dataset_id }}';

const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      dataset: null,
      loading: false,
      error: null,
      datasetId: DATASET_ID,
      activeTab: 'basic', // ÈªòËÆ§ÊòæÁ§∫Âü∫Êú¨‰ø°ÊÅØtab
      
      // ÁâàÊú¨ÂàóË°®Áõ∏ÂÖ≥Êï∞ÊçÆ
      versions: [],
      versionsLoading: false,
      versionsError: null,
      currentPage: 1,
      pageSize: 10,
      totalVersions: 0,
      
      // ÂØºÂÖ•Êï∞ÊçÆÁõ∏ÂÖ≥Êï∞ÊçÆ
      importMethod: 'existing', // ÈªòËÆ§ÈÄâ‰∏≠Â∑≤ÊúâÊï∞ÊçÆÈõÜ
      availableDatasets: [], // ÂèØÈÄâÊï∞ÊçÆÈõÜÂàóË°®
      datasetVersions: [], // Êï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®
      formData: {
        sourceDataset: '',
        datasetVersion: '',
        cleanData: false,
        nameStrategy: 'target', // ÈªòËÆ§ÈÄâ‰∏≠‰øùÁïôÁõÆÁöÑÊñá‰ª∂
        resourcePool: '',
        queue: ''
      }

    }
  },
  computed: {
    totalPages() {
      return Math.ceil(this.totalVersions / this.pageSize);
    }
  },
  methods: {
    async showImportDrawer(version) {
      // Á°Æ‰øùÈªòËÆ§ÈÄâ‰∏≠Â∑≤ÊúâÊï∞ÊçÆÈõÜ
      this.importMethod = 'existing';
      
      // Á°Æ‰øùÈªòËÆ§ÈÄâ‰∏≠‰øùÁïôÁõÆÁöÑÊñá‰ª∂
      this.formData.nameStrategy = 'target';
      
      console.log('ËÆæÁΩÆÈªòËÆ§ÂÄº - importMethod:', this.importMethod, 'nameStrategy:', this.formData.nameStrategy);
      
      // Âä†ËΩΩÂèØÈÄâÊï∞ÊçÆÈõÜÂàóË°®
      await this.loadAvailableDatasets();
      
      console.log('Êï∞ÊçÆÈõÜÂàóË°®Âä†ËΩΩÂÆåÊàêÔºåÊï∞Èáè:', this.availableDatasets.length);
      console.log('Êï∞ÊçÆÈõÜÂàóË°®ÂÜÖÂÆπ:', this.availableDatasets);
      
      // Âº∫Âà∂Vue.jsÊõ¥Êñ∞
      this.$forceUpdate();
      
      // ‰ΩøÁî®$nextTickÁ°Æ‰øùVue.jsÂìçÂ∫îÂºèÊõ¥Êñ∞ÂÆåÊàêÂêéÂÜçÊòæÁ§∫ÊäΩÂ±â
      this.$nextTick(() => {
        // Êõ¥Êñ∞Êï∞ÊçÆÈõÜ‰ø°ÊÅØ
        const datasetName = document.querySelector('h5') ? document.querySelector('h5').textContent : 'Êï∞ÊçÆÈõÜ';
        document.getElementById('dataset-name').textContent = datasetName;
        
        // ÊòæÁ§∫ÁâàÊú¨‰ø°ÊÅØ
        const versionText = version && version.version ? version.version : 'ÂΩìÂâçÁâàÊú¨';
        document.getElementById('dataset-version').textContent = versionText;
        
        // ÊòæÁ§∫ÊäΩÂ±â
        document.getElementById('drawer').style.display = 'flex';
        document.getElementById('drawer-overlay').style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // ÂÜçÊ¨°Á°ÆËÆ§ÈªòËÆ§ÂÄºËÆæÁΩÆ
        console.log('ÊäΩÂ±âÊòæÁ§∫Âêé - importMethod:', this.importMethod, 'nameStrategy:', this.formData.nameStrategy);
        console.log('ÊäΩÂ±âÊòæÁ§∫Âêé - availableDatasets:', this.availableDatasets);
        
        // Ê£ÄÊü•DOM‰∏≠ÁöÑÂçïÈÄâÊåâÈíÆÁä∂ÊÄÅ
        const existingRadio = document.querySelector('input[value="existing"]');
        const targetRadio = document.querySelector('input[value="target"]');
        console.log('DOMÊ£ÄÊü• - existing radio checked:', existingRadio ? existingRadio.checked : 'not found');
        console.log('DOMÊ£ÄÊü• - target radio checked:', targetRadio ? targetRadio.checked : 'not found');
        
        // Ê£ÄÊü•Ê∫êÊï∞ÊçÆÈõÜ‰∏ãÊãâÊ°Ü
        const sourceDatasetSelect = document.querySelector('select[v-model="formData.sourceDataset"]');
        console.log('Ê∫êÊï∞ÊçÆÈõÜ‰∏ãÊãâÊ°Ü:', sourceDatasetSelect);
        if (sourceDatasetSelect) {
          console.log('‰∏ãÊãâÊ°ÜÈÄâÈ°πÊï∞Èáè:', sourceDatasetSelect.options.length);
          for (let i = 0; i < sourceDatasetSelect.options.length; i++) {
            console.log(`ÈÄâÈ°π ${i}:`, sourceDatasetSelect.options[i].text, sourceDatasetSelect.options[i].value);
          }
        }
      });
    },
    onSourceDatasetChange() {
      // ÂΩìÈÄâÊã©Ê∫êÊï∞ÊçÆÈõÜÊó∂ÔºåÂä†ËΩΩÂØπÂ∫îÁöÑÁâàÊú¨ÂàóË°®
      if (this.formData.sourceDataset) {
        this.loadDatasetVersions(this.formData.sourceDataset);
        // Ê∏ÖÁ©∫‰πãÂâçÈÄâÊã©ÁöÑÁâàÊú¨
        this.formData.datasetVersion = '';
      } else {
        this.datasetVersions = [];
        this.formData.datasetVersion = '';
      }
    },
    async loadAvailableDatasets() {
      try {
        console.log('Ëé∑ÂèñÊï∞ÊçÆÈõÜÂàóË°®...');
        const response = await axios.get('/api?action=DescribeDatasets');
        console.log('Êï∞ÊçÆÈõÜÂàóË°®APIÂìçÂ∫î:', response.data);
        
        if (response.data && response.data.Datasets) {
          this.availableDatasets = response.data.Datasets;
          console.log('Êï∞ÊçÆÈõÜÂàóË°®Âä†ËΩΩÊàêÂäü:', this.availableDatasets);
        } else if (response.data && response.data.datasets) {
          this.availableDatasets = response.data.datasets;
          console.log('Êï∞ÊçÆÈõÜÂàóË°®Âä†ËΩΩÊàêÂäü:', this.availableDatasets);
        } else {
          console.log('Êï∞ÊçÆÈõÜÂàóË°®‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
          this.availableDatasets = [];
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÊï∞ÊçÆÈõÜÂàóË°®Â§±Ë¥•:', error);
        this.availableDatasets = [];
      }
    },
    async loadDatasetVersions(datasetId) {
      if (!datasetId) {
        this.datasetVersions = [];
        return;
      }
      
      try {
        console.log('Ëé∑ÂèñÊï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®:', datasetId);
        const response = await axios.get('/api?action=DescribeDatasetVersions&datasetId=' + encodeURIComponent(datasetId) + '&pageNumber=1&pageSize=100');
        console.log('Êï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®APIÂìçÂ∫î:', response.data);
        
        if (response.data && response.data.Versions) {
          this.datasetVersions = response.data.Versions;
          console.log('Êï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®Âä†ËΩΩÊàêÂäü:', this.datasetVersions);
        } else if (response.data && response.data.versions) {
          this.datasetVersions = response.data.versions;
          console.log('Êï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®Âä†ËΩΩÊàêÂäü:', this.datasetVersions);
        } else {
          console.log('Êï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
          this.datasetVersions = [];
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÊï∞ÊçÆÈõÜÁâàÊú¨ÂàóË°®Â§±Ë¥•:', error);
        this.datasetVersions = [];
      }
    },
    async loadDataset() {
      console.log('loadDataset called for ID:', this.datasetId);
      this.loading = true;
      this.error = null;
      
      try {
        console.log('Making API request...');
        const response = await axios.get('/api?action=DescribeDataset&datasetId=' + encodeURIComponent(this.datasetId));
        console.log('API response received:', response.data);
        const data = response.data;
        
        if (data.error) {
          this.error = data.error;
          return;
        }
        
        // Êï∞ÊçÆÈõÜËØ¶ÊÉÖÁõ¥Êé•Âú®data‰∏≠ÔºåËÄå‰∏çÊòØÂú®data.datasetÊàñdata.Dataset‰∏≠
        this.dataset = data;
        console.log('Dataset loaded:', this.dataset);
        console.log('Dataset name:', this.dataset ? this.dataset.name : 'undefined');
        console.log('Dataset ID:', this.dataset ? this.dataset.id : 'undefined');
      } catch (err) {
        console.error('Error loading dataset:', err);
        this.error = 'Âä†ËΩΩÊï∞ÊçÆÈõÜËØ¶ÊÉÖÂ§±Ë¥•: ' + err.message;
      } finally {
        this.loading = false;
      }
    },
    async loadVersions() {
      console.log('loadVersions called for ID:', this.datasetId);
      this.versionsLoading = true;
      this.versionsError = null;
      
      try {
        console.log('Making versions API request...');
        const response = await axios.get('/api?action=DescribeDatasetVersions&datasetId=' + encodeURIComponent(this.datasetId) + '&pageNumber=' + this.currentPage + '&pageSize=' + this.pageSize);
        console.log('Versions API response received:', response.data);
        const data = response.data;
        
        if (data.error) {
          this.versionsError = data.error;
          return;
        }
        
        // ÁâàÊú¨ÂàóË°®Âú®data.versions‰∏≠ÔºåÊÄªÊï∞Âú®data.totalCount‰∏≠
        this.versions = data.versions || data.Versions || [];
        this.totalVersions = data.totalCount || data.TotalCount || 0;
        console.log('Versions loaded:', this.versions);
      } catch (err) {
        console.error('Error loading versions:', err);
        this.versionsError = 'Âä†ËΩΩÁâàÊú¨ÂàóË°®Â§±Ë¥•: ' + err.message;
      } finally {
        this.versionsLoading = false;
      }
    },
    switchTab(tabName) {
      this.activeTab = tabName;
      // Â¶ÇÊûúÂàáÊç¢Âà∞ÁâàÊú¨ÂàóË°®tab‰∏îÁâàÊú¨ÂàóË°®‰∏∫Á©∫ÔºåÂàôÂä†ËΩΩÁâàÊú¨ÂàóË°®
      if (tabName === 'versions' && this.versions.length === 0 && !this.versionsError) {
        this.loadVersions();
      }
    },
    prevPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.loadVersions();
      }
    },
    nextPage() {
      if (this.currentPage < this.totalPages) {
        this.currentPage++;
        this.loadVersions();
      }
    },
    // Êèê‰∫§ÂØºÂÖ•Ë°®Âçï
    async submitImportForm() {
        console.log('submitImportForm called');
      // Ë°®ÂçïÈ™åËØÅ
      if (this.importMethod === 'existing' && (!this.formData.sourceDataset || !this.formData.datasetVersion)) {
        alert('ËØ∑ÈÄâÊã©Ê∫êÊï∞ÊçÆÈõÜÂíåÊï∞ÊçÆÁâàÊú¨');
        return;
      }
      
      if (!this.formData.nameStrategy) {
        alert('ËØ∑ÈÄâÊã©ÂêåÂêç‰øùÁïôÁ≠ñÁï•');
        return;
      }
      
      if (!this.formData.resourcePool || !this.formData.queue) {
        alert('ËØ∑ÈÄâÊã©ËµÑÊ∫êÊ±†ÂíåÈòüÂàó');
        return;
      }
      
      // ÊûÑÂª∫ÂØºÂÖ•Êï∞ÊçÆËØ∑Ê±ÇÂèÇÊï∞
      const requestParams = {
        datasetId: this.datasetId,
        versionId: this.currentVersion ? this.currentVersion.id : null,
        importMethod: this.importMethod,
        sourceDataset: this.formData.sourceDataset,
        datasetVersion: this.formData.datasetVersion,
        cleanData: this.formData.cleanData,
        nameStrategy: this.formData.nameStrategy,
        resourcePool: this.formData.resourcePool,
        queue: this.formData.queue
      };
      
      console.log('ÂØºÂÖ•Êï∞ÊçÆËØ∑Ê±ÇÂèÇÊï∞:', requestParams);
      
      try {
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        const submitBtn = document.querySelector('.form-actions .btn-primary');
        if (submitBtn) {
          submitBtn.textContent = 'Êèê‰∫§‰∏≠...';
          submitBtn.disabled = true;
        }
        
        // Ë∞ÉÁî®ÂØºÂÖ•Êï∞ÊçÆAPI
        const response = await axios.post('/api?action=ImportDatasetData', requestParams);
        console.log('ÂØºÂÖ•Êï∞ÊçÆAPIÂìçÂ∫î:', response.data);
        
        if (response.data.error) {
          alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•: ' + response.data.error);
        } else {
          alert('ÂØºÂÖ•Êï∞ÊçÆËØ∑Ê±ÇÂ∑≤ÊàêÂäüÊèê‰∫§ÔºÅ');
          // ÂÖ≥Èó≠ÊäΩÂ±â
          this.closeDrawer();
        }
      } catch (error) {
        console.error('ÂØºÂÖ•Êï∞ÊçÆAPIË∞ÉÁî®Â§±Ë¥•:', error);
        alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•: ' + (error.response?.data?.error || error.message || 'Êú™Áü•ÈîôËØØ'));
      } finally {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        const submitBtn = document.querySelector('.form-actions .btn-primary');
        if (submitBtn) {
          submitBtn.textContent = 'Á°ÆÂÆö';
          submitBtn.disabled = false;
        }
      }
    },
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    },
    formatVisibility(visibilityScope) {
      if (!visibilityScope) return 'N/A';
      const visibilityMap = {
        'ALL_PEOPLE': 'ÊâÄÊúâ‰∫∫ÂèØËßÅ',
        'USER_GROUP': 'Áî®Êà∑ÁªÑÂèØËßÅ',
        'ONLY_OWNER': '‰ªÖÊâÄÊúâËÄÖÂèØËßÅ'
      };
      return visibilityMap[visibilityScope] || visibilityScope;
    },
    copyDatasetId(id) {
      if (!id) return;
      
      // ‰ΩøÁî®Áé∞‰ª£ÊµèËßàÂô®ÁöÑClipboard API
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(id).then(() => {
          this.showCopySuccess();
        }).catch(err => {
          console.error('Â§çÂà∂Â§±Ë¥•:', err);
          this.fallbackCopy(id);
        });
      } else {
        // ÈôçÁ∫ßÊñπÊ°à
        this.fallbackCopy(id);
      }
    },
    fallbackCopy(text) {
      // ÂàõÂª∫‰∏¥Êó∂ÊñáÊú¨Âå∫Âüü
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        this.showCopySuccess();
      } catch (err) {
        console.error('Â§çÂà∂Â§±Ë¥•:', err);
      }
      
      document.body.removeChild(textArea);
    },
    showCopySuccess() {
      // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊèêÁ§∫
      const toast = document.createElement('div');
      toast.textContent = 'Êï∞ÊçÆÈõÜIDÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #52c41a;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(toast);
      
      // 3ÁßíÂêéËá™Âä®ÁßªÈô§
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);
    }
  },
  mounted() {
    // Á°Æ‰øùÊäΩÂ±âÂàùÂßãÁä∂ÊÄÅÊòØÈöêËóèÁöÑ
    this.drawerVisible = false;
    this.loadDataset();
  }
}).mount('#app');
</script>
{% endblock %}