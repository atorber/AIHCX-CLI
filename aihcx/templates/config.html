{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX å‚æ•°é…ç½®{% endblock %}

{% block header_title %}âš™ï¸ å‚æ•°é…ç½®{% endblock %}
{% block header_subtitle %}é…ç½®AIHCXè¿æ¥å‚æ•°{% endblock %}

{% block extra_css %}
<style>
.config-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 28px 0;
}
h2 { text-align: center; color: #111827; margin-bottom: 22px; font-size: 22px; font-weight: 600; }
form { display: flex; flex-direction: column; gap: 16px; }

/* å·¦å³ç»“æ„ */
.field-row { 
  display: grid; 
  grid-template-columns: 180px 1fr; 
  align-items: start; 
  column-gap: 16px; 
}
.field-row + .field-row { margin-top: 6px; }
.field-row label { 
  color: #374151; 
  font-size: 14px; 
  font-weight: 600; 
  text-align: right; 
  margin: 0; 
  padding-top: 6px; 
}
.field-row .control { display: flex; flex-direction: column; gap: 6px; }

input[type=text], input[type=password] {
  padding: 10px 12px; 
  border: 1.5px solid #e5e7eb; 
  border-radius: 10px; 
  font-size: 14px; 
  background: #fff;
  transition: box-shadow 0.15s ease, border-color 0.15s ease;
  width: 100%;
  box-sizing: border-box;
}
input[type=text]:focus, input[type=password]:focus {
  border-color: #2b6def; 
  outline: none;
  box-shadow: 0 0 0 3px rgba(43, 109, 239, 0.12);
}

/* æ ¡éªŒæ€ */
.field-row.error input { border-color: #dc3545; background: #fff5f5; }
.field-row.error label { color: #dc3545; }
.small-error { color: #dc3545; font-size: 13px; }

.help-text { font-size: 13px; color: #6b7280; line-height: 1.5; }
.required { color: #dc3545; margin-left: 4px; }

.btn-row { display: flex; gap: 12px; margin-top: 8px; margin-left: 180px; }
button {
  background: #2b6def; 
  color: #fff; 
  border: none; 
  border-radius: 10px; 
  padding: 10px 16px; 
  font-size: 14px; 
  font-weight: 600;
  cursor: pointer; 
  transition: all 0.15s ease;
  min-height: 40px;
}
button:hover { background: #1f5bd8; box-shadow: 0 4px 12px rgba(43, 109, 239, 0.25); }
button:disabled { background: #9ca3af; cursor: not-allowed; }

.msg { text-align: left; color: #16a34a; margin-top: 12px; font-size: 14px; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; }
.error-msg { text-align: left; color: #dc3545; margin-top: 12px; font-size: 14px; padding: 10px; background: #fff1f2; border: 1px solid #fecdd3; border-radius: 8px; }

</style>
{% endblock %}

{% block navigation %}
{{ navigation() }}
{% endblock %}

{% block content %}
<div id="app" class="config-container">
  <!-- <h2>âš™ï¸ å‚æ•°é…ç½®</h2> -->
  
  <form @submit.prevent="saveConfig">
    <div class="field-row" :class="{ error: errors.host }">
      <label for="host">Host <span class="required">*</span></label>
      <div class="control">
        <input 
          type="text" 
          id="host" 
          v-model="config.host" 
          placeholder="ä¾‹å¦‚: aihc.bj.baidubce.com"
          required
        >
        <div class="help-text">AIHCæœåŠ¡çš„è®¿é—®åœ°å€</div>
        <div v-if="errors.host" class="small-error">[[ errors.host ]]</div>
      </div>
    </div>
    
    <div class="field-row" :class="{ error: errors.access_key }">
      <label for="access_key">Access Key <span class="required">*</span></label>
      <div class="control">
        <input 
          type="text" 
          id="access_key" 
          v-model="config.access_key" 
          placeholder="è¯·è¾“å…¥æ‚¨çš„Access Key"
          required
        >
        <div class="help-text">ç”¨äºèº«ä»½éªŒè¯çš„Access Key</div>
        <div v-if="errors.access_key" class="small-error">[[ errors.access_key ]]</div>
      </div>
    </div>
    
    <div class="field-row" :class="{ error: errors.secret_key }">
      <label for="secret_key">Secret Key <span class="required">*</span></label>
      <div class="control">
        <input 
          type="password" 
          id="secret_key" 
          v-model="config.secret_key" 
          placeholder="è¯·è¾“å…¥æ‚¨çš„Secret Key"
          required
        >
        <div class="help-text">ç”¨äºèº«ä»½éªŒè¯çš„Secret Key</div>
        <div v-if="errors.secret_key" class="small-error">[[ errors.secret_key ]]</div>
      </div>
    </div>
    
    <div class="field-row">
      <label for="pool">Pool</label>
      <div class="control">
        <input 
          type="text" 
          id="pool" 
          v-model="config.pool" 
          placeholder="é»˜è®¤èµ„æºæ± ID"
        >
        <div class="help-text">é»˜è®¤ä½¿ç”¨çš„èµ„æºæ± IDï¼ˆå¯é€‰ï¼‰</div>
      </div>
    </div>
    
    <div class="field-row">
      <label for="queue">Queue</label>
      <div class="control">
        <input 
          type="text" 
          id="queue" 
          v-model="config.queue" 
          placeholder="é»˜è®¤é˜Ÿåˆ—åç§°"
        >
        <div class="help-text">é»˜è®¤ä½¿ç”¨çš„é˜Ÿåˆ—åç§°ï¼ˆå¯é€‰ï¼‰</div>
      </div>
    </div>
    
    <div class="field-row">
      <label for="path">Path</label>
      <div class="control">
        <input 
          type="text" 
          id="path" 
          v-model="config.path" 
          placeholder="é»˜è®¤è·¯å¾„"
        >
        <div class="help-text">é»˜è®¤ä½¿ç”¨çš„è·¯å¾„ï¼ˆå¯é€‰ï¼‰</div>
      </div>
    </div>
    
    <div class="btn-row">
      <button type="submit" :disabled="saving">
        <span v-if="saving">ğŸ’¾ ä¿å­˜ä¸­...</span>
        <span v-else>ğŸ’¾ ä¿å­˜é…ç½®</span>
      </button>
      <button type="button" @click="resetForm" :disabled="saving">ğŸ”„ é‡ç½®</button>
    </div>
  </form>
  
  <div v-if="successMessage" class="msg">âœ… [[ successMessage ]]</div>
  <div v-if="errorMessage" class="error-msg">âŒ [[ errorMessage ]]</div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      config: {
        host: '{{ host|default("") }}',
        access_key: '{{ access_key|default("") }}',
        secret_key: '{{ secret_key|default("") }}',
        pool: '{{ pool|default("") }}',
        queue: '{{ queue|default("") }}',
        path: '{{ path|default("") }}'
      },
      errors: {},
      saving: false,
      successMessage: '',
      errorMessage: ''
    }
  },
  methods: {
    validateForm() {
      this.errors = {};
      
      if (!this.config.host.trim()) {
        this.errors.host = 'Hostæ˜¯å¿…å¡«é¡¹';
      } else if (!this.isValidUrl(this.config.host)) {
        this.errors.host = 'è¯·è¾“å…¥æœ‰æ•ˆçš„Hoståœ°å€';
      }
      
      if (!this.config.access_key.trim()) {
        this.errors.access_key = 'Access Keyæ˜¯å¿…å¡«é¡¹';
      }
      
      if (!this.config.secret_key.trim()) {
        this.errors.secret_key = 'Secret Keyæ˜¯å¿…å¡«é¡¹';
      }
      
      return Object.keys(this.errors).length === 0;
    },
    isValidUrl(string) {
      try {
        new URL(`https://${string}`);
        return true;
      } catch (_) {
        return false;
      }
    },
    async saveConfig() {
      if (!this.validateForm()) {
        return;
      }
      
      this.saving = true;
      this.successMessage = '';
      this.errorMessage = '';
      
      try {
        const formData = new FormData();
        Object.keys(this.config).forEach(key => {
          if (this.config[key]) {
            formData.append(key, this.config[key]);
          }
        });
        
        const response = await fetch('/config', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          this.successMessage = 'é…ç½®ä¿å­˜æˆåŠŸï¼';
          // æ¸…é™¤é”™è¯¯ä¿¡æ¯
          this.errors = {};
        } else {
          this.errorMessage = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
        }
      } catch (error) {
        this.errorMessage = 'ä¿å­˜å¤±è´¥: ' + error.message;
      } finally {
        this.saving = false;
      }
    },
    resetForm() {
      this.config = {
        host: '{{ host|default("") }}',
        access_key: '{{ access_key|default("") }}',
        secret_key: '{{ secret_key|default("") }}',
        pool: '{{ pool|default("") }}',
        queue: '{{ queue|default("") }}',
        path: '{{ path|default("") }}'
      };
      this.errors = {};
      this.successMessage = '';
      this.errorMessage = '';
    }
  }
}).mount('#app');
</script>
{% endblock %} 