{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX å‚æ•°é…ç½®{% endblock %}

{% block header_title %}âš™ï¸ å‚æ•°é…ç½®{% endblock %}
{% block header_subtitle %}é…ç½®AIHCXè¿æ¥å‚æ•°{% endblock %}

{% block extra_css %}
<style>
.config-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 40px;
}
h2 { text-align: center; color: #333; margin-bottom: 28px; font-size: 2em; }
form { display: flex; flex-direction: column; gap: 20px; }
label { color: #555; font-size: 15px; margin-bottom: 6px; font-weight: 500; }
input[type=text], input[type=password] {
  padding: 12px 16px; 
  border: 2px solid #e9ecef; 
  border-radius: 8px; 
  font-size: 15px; 
  background: #fafbfc;
  transition: all 0.3s ease;
  width: 100%;
  box-sizing: border-box;
}
input[type=text]:focus, input[type=password]:focus {
  border-color: #409eff; 
  outline: none;
  box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.1);
  background: #fff;
}
.btn-row { display: flex; gap: 15px; margin-top: 10px; }
button {
  background: #409eff; 
  color: #fff; 
  border: none; 
  border-radius: 8px; 
  padding: 12px 24px; 
  font-size: 16px; 
  font-weight: 500;
  cursor: pointer; 
  transition: all 0.3s ease;
  flex: 1;
  min-height: 48px;
}
button:hover {
  background: #3076c9;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}
button:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
.msg { 
  text-align: center; 
  color: #52c41a; 
  margin-top: 20px; 
  font-size: 15px; 
  padding: 12px;
  background: #f6ffed;
  border: 1px solid #b7eb8f;
  border-radius: 6px;
}
.error-msg { 
  text-align: center; 
  color: #dc3545; 
  margin-top: 20px; 
  font-size: 15px; 
  padding: 12px;
  background: #fff2f0;
  border: 1px solid #ffccc7;
  border-radius: 6px;
}
.field { display: flex; flex-direction: column; }
.field.error input {
  border-color: #dc3545;
  background: #fff5f5;
}
.field.error label {
  color: #dc3545;
}
.help-text {
  font-size: 13px;
  color: #666;
  margin-top: 6px;
  line-height: 1.4;
}
.required {
  color: #dc3545;
  margin-left: 4px;
}
</style>
{% endblock %}

{% block navigation %}
{{ navigation() }}
{% endblock %}

{% block content %}
<div id="app" class="config-container">
  <h2>âš™ï¸ å‚æ•°é…ç½®</h2>
  
  <form @submit.prevent="saveConfig">
    <div class="field" :class="{ error: errors.host }">
      <label for="host">Host <span class="required">*</span></label>
      <input 
        type="text" 
        id="host" 
        v-model="config.host" 
        placeholder="ä¾‹å¦‚: aihc.bj.baidubce.com"
        required
      >
      <div class="help-text">AIHCæœåŠ¡çš„è®¿é—®åœ°å€</div>
      <div v-if="errors.host" class="error-msg">[[ errors.host ]]</div>
    </div>
    
    <div class="field" :class="{ error: errors.access_key }">
      <label for="access_key">Access Key <span class="required">*</span></label>
      <input 
        type="text" 
        id="access_key" 
        v-model="config.access_key" 
        placeholder="è¯·è¾“å…¥æ‚¨çš„Access Key"
        required
      >
      <div class="help-text">ç”¨äºèº«ä»½éªŒè¯çš„Access Key</div>
      <div v-if="errors.access_key" class="error-msg">[[ errors.access_key ]]</div>
    </div>
    
    <div class="field" :class="{ error: errors.secret_key }">
      <label for="secret_key">Secret Key <span class="required">*</span></label>
      <input 
        type="password" 
        id="secret_key" 
        v-model="config.secret_key" 
        placeholder="è¯·è¾“å…¥æ‚¨çš„Secret Key"
        required
      >
      <div class="help-text">ç”¨äºèº«ä»½éªŒè¯çš„Secret Key</div>
      <div v-if="errors.secret_key" class="error-msg">[[ errors.secret_key ]]</div>
    </div>
    
    <div class="field">
      <label for="pool">Pool</label>
      <input 
        type="text" 
        id="pool" 
        v-model="config.pool" 
        placeholder="é»˜è®¤èµ„æºæ± ID"
      >
      <div class="help-text">é»˜è®¤ä½¿ç”¨çš„èµ„æºæ± IDï¼ˆå¯é€‰ï¼‰</div>
    </div>
    
    <div class="field">
      <label for="queue">Queue</label>
      <input 
        type="text" 
        id="queue" 
        v-model="config.queue" 
        placeholder="é»˜è®¤é˜Ÿåˆ—åç§°"
      >
      <div class="help-text">é»˜è®¤ä½¿ç”¨çš„é˜Ÿåˆ—åç§°ï¼ˆå¯é€‰ï¼‰</div>
    </div>
    
    <div class="field">
      <label for="path">Path</label>
      <input 
        type="text" 
        id="path" 
        v-model="config.path" 
        placeholder="é»˜è®¤è·¯å¾„"
      >
      <div class="help-text">é»˜è®¤ä½¿ç”¨çš„è·¯å¾„ï¼ˆå¯é€‰ï¼‰</div>
    </div>
    
    <div class="btn-row">
      <button type="submit" :disabled="saving">
        <span v-if="saving">ğŸ’¾ ä¿å­˜ä¸­...</span>
        <span v-else>ğŸ’¾ ä¿å­˜é…ç½®</span>
      </button>
      <button type="button" @click="resetForm" :disabled="saving">ğŸ”„ é‡ç½®</button>
    </div>
  </form>
  
  <div v-if="successMessage" class="msg">âœ… [[ successMessage ]]</div>
  <div v-if="errorMessage" class="error-msg">âŒ [[ errorMessage ]]</div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      config: {
        host: '{{ host|default("") }}',
        access_key: '{{ access_key|default("") }}',
        secret_key: '{{ secret_key|default("") }}',
        pool: '{{ pool|default("") }}',
        queue: '{{ queue|default("") }}',
        path: '{{ path|default("") }}'
      },
      errors: {},
      saving: false,
      successMessage: '',
      errorMessage: ''
    }
  },
  methods: {
    validateForm() {
      this.errors = {};
      
      if (!this.config.host.trim()) {
        this.errors.host = 'Hostæ˜¯å¿…å¡«é¡¹';
      } else if (!this.isValidUrl(this.config.host)) {
        this.errors.host = 'è¯·è¾“å…¥æœ‰æ•ˆçš„Hoståœ°å€';
      }
      
      if (!this.config.access_key.trim()) {
        this.errors.access_key = 'Access Keyæ˜¯å¿…å¡«é¡¹';
      }
      
      if (!this.config.secret_key.trim()) {
        this.errors.secret_key = 'Secret Keyæ˜¯å¿…å¡«é¡¹';
      }
      
      return Object.keys(this.errors).length === 0;
    },
    isValidUrl(string) {
      try {
        new URL(`https://${string}`);
        return true;
      } catch (_) {
        return false;
      }
    },
    async saveConfig() {
      if (!this.validateForm()) {
        return;
      }
      
      this.saving = true;
      this.successMessage = '';
      this.errorMessage = '';
      
      try {
        const formData = new FormData();
        Object.keys(this.config).forEach(key => {
          if (this.config[key]) {
            formData.append(key, this.config[key]);
          }
        });
        
        const response = await fetch('/config', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          this.successMessage = 'é…ç½®ä¿å­˜æˆåŠŸï¼';
          // æ¸…é™¤é”™è¯¯ä¿¡æ¯
          this.errors = {};
        } else {
          this.errorMessage = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
        }
      } catch (error) {
        this.errorMessage = 'ä¿å­˜å¤±è´¥: ' + error.message;
      } finally {
        this.saving = false;
      }
    },
    resetForm() {
      this.config = {
        host: '{{ host|default("") }}',
        access_key: '{{ access_key|default("") }}',
        secret_key: '{{ secret_key|default("") }}',
        pool: '{{ pool|default("") }}',
        queue: '{{ queue|default("") }}',
        path: '{{ path|default("") }}'
      };
      this.errors = {};
      this.successMessage = '';
      this.errorMessage = '';
    }
  }
}).mount('#app');
</script>
{% endblock %} 