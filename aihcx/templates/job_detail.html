{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX ä»»åŠ¡è¯¦æƒ…{% endblock %}

{% block header_title %}ğŸ“‹ ä»»åŠ¡è¯¦æƒ…{% endblock %}
{% block header_subtitle %}æŸ¥çœ‹è®­ç»ƒä»»åŠ¡è¯¦ç»†ä¿¡æ¯{% endblock %}

{% block extra_css %}
<style>
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .job-card {
        background: var(--panel-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .job-card-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .job-card-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
    }
    
    .job-card-body {
        padding: 24px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .info-item {
        margin-bottom: 16px;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    .info-value {
        font-size: 15px;
        color: var(--text);
        word-break: break-all;
    }
    
    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-running {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-cancelled {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .status-unknown {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    
    .error {
        text-align: center;
        padding: 40px;
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    
    .empty-state i {
        font-size: 48px;
        color: #adb5bd;
        margin-bottom: 16px;
    }
    
    .command-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 16px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .labels-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .label-tag {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-family: monospace;
    }
    
    .env-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 16px;
    }
    
    .env-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .env-item:last-child {
        border-bottom: none;
    }
    
    .env-name {
        font-weight: 600;
        color: #495057;
        font-family: monospace;
        font-size: 13px;
    }
    
    .env-value {
        color: var(--text);
        font-family: monospace;
        font-size: 13px;
        word-break: break-all;
        max-width: 60%;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <div class="page-container">
        <!-- æ“ä½œæ  -->
        <div class="action-bar">
            <a :href="backUrl" class="btn-back">
                [[ backText ]]
            </a>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> ä»»åŠ¡è¯¦æƒ…åŠ è½½ä¸­...
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div v-if="error" class="error">
            <i class="fas fa-exclamation-circle"></i> [[ error ]]
        </div>

        <!-- ä»»åŠ¡è¯¦æƒ… -->
        <div v-if="jobDetail && !loading && !error">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="job-card">
                <div class="job-card-header">
                    <h5>åŸºæœ¬ä¿¡æ¯</h5>
                </div>
                <div class="job-card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ä»»åŠ¡åç§°</div>
                            <div class="info-value">[[ jobDetail.name ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä»»åŠ¡ID</div>
                            <div class="info-value">[[ jobDetail.jobId ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">çŠ¶æ€</div>
                            <div class="info-value">
                                <span class="status" :class="statusClass(jobDetail.status)">
                                    [[ statusText(jobDetail.status) ]]
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä»»åŠ¡ç±»å‹</div>
                            <div class="info-value">[[ jobDetail.jobType ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä¼˜å…ˆçº§</div>
                            <div class="info-value">[[ jobDetail.priority ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">é˜Ÿåˆ—</div>
                            <div class="info-value">[[ jobDetail.queueName ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">èµ„æºæ± ID</div>
                            <div class="info-value">[[ jobDetail.resourcePoolId ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="info-value">[[ formatDate(jobDetail.createdAt) ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å®Œæˆæ—¶é—´</div>
                            <div class="info-value">[[ formatDate(jobDetail.finishedAt) ]]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡è§„æ ¼ -->
            <div class="job-card" v-if="jobDetail.jobSpec">
                <div class="job-card-header">
                    <h5>ä»»åŠ¡è§„æ ¼</h5>
                </div>
                <div class="job-card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">é•œåƒ</div>
                            <div class="info-value">[[ jobDetail.jobSpec.image ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å‰¯æœ¬æ•°</div>
                            <div class="info-value">[[ jobDetail.jobSpec.replicas ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å¯ç”¨RDMA</div>
                            <div class="info-value">[[ jobDetail.jobSpec.enableRDMA ? 'æ˜¯' : 'å¦' ]]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰§è¡Œå‘½ä»¤ -->
            <div class="job-card" v-if="jobDetail.command">
                <div class="job-card-header">
                    <h5>æ‰§è¡Œå‘½ä»¤</h5>
                </div>
                <div class="job-card-body">
                    <div class="command-container">[[ jobDetail.command ]]</div>
                </div>
            </div>

            <!-- ç¯å¢ƒå˜é‡ -->
            <div class="job-card" v-if="jobDetail.jobSpec && jobDetail.jobSpec.envs && jobDetail.jobSpec.envs.length > 0">
                <div class="job-card-header">
                    <h5>ç¯å¢ƒå˜é‡</h5>
                </div>
                <div class="job-card-body">
                    <div class="env-container">
                        <div class="env-item" v-for="env in jobDetail.jobSpec.envs" :key="env.name">
                            <span class="env-name">[[ env.name ]]</span>
                            <span class="env-value">[[ env.value ]]</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾ -->
            <div class="job-card" v-if="jobDetail.labels && jobDetail.labels.length > 0">
                <div class="job-card-header">
                    <h5>æ ‡ç­¾</h5>
                </div>
                <div class="job-card-body">
                    <div class="labels-container">
                        <span class="label-tag" v-for="label in jobDetail.labels" :key="label.key">
                            [[ label.key ]]: [[ label.value ]]
                        </span>
                    </div>
                </div>
            </div>

            <!-- Podä¿¡æ¯ -->
            <div class="job-card" v-if="jobDetail.pods && jobDetail.pods.length > 0">
                <div class="job-card-header">
                    <h5>Podä¿¡æ¯</h5>
                </div>
                <div class="job-card-body">
                    <div v-for="pod in jobDetail.pods" :key="pod.name" style="margin-bottom: 16px;">
                        <div class="info-item">
                            <div class="info-label">Podåç§°</div>
                            <div class="info-value">[[ pod.name ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">çŠ¶æ€</div>
                            <div class="info-value">
                                <span class="status" :class="statusClass(pod.status)">
                                    [[ statusText(pod.status) ]]
                                </span>
                            </div>
                        </div>
                        <div class="info-item" v-if="pod.nodeName">
                            <div class="info-label">èŠ‚ç‚¹</div>
                            <div class="info-value">[[ pod.nodeName ]]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-if="!loading && !error && !jobDetail" class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>æœªæ‰¾åˆ°ä»»åŠ¡è¯¦æƒ…</p>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      jobId: null,
      jobDetail: null,
      loading: false,
      error: null,
      fromPage: null,
      datasetId: null,
      backUrl: '/jobs',
      backText: 'â† è¿”å›ä»»åŠ¡åˆ—è¡¨'
    }
  },
  methods: {
    async loadJobDetail() {
      this.loading = true;
      this.error = null;
      
      try {
        // ä»URLå‚æ•°è·å–jobIdå’ŒresourcePoolId
        const urlParams = new URLSearchParams(window.location.search);
        // ä»URLè·¯å¾„ä¸­æå–jobId: /jobs/job-xxx -> job-xxx
        const pathParts = window.location.pathname.split('/');
        this.jobId = urlParams.get('jobId') || pathParts[pathParts.length - 1];
        
        
        if (!this.jobId) {
          throw new Error('ç¼ºå°‘ä»»åŠ¡IDå‚æ•°');
        }
        
        // è·å–èµ„æºæ± IDï¼ˆä»URLå‚æ•°æˆ–é»˜è®¤å€¼ï¼‰
        const resourcePoolId = urlParams.get('resourcePoolId') || 'aihc-serverless';
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const queryParams = new URLSearchParams({
          action: 'DescribeJob',
          resourcePoolId: resourcePoolId
        });
        
        // æ„å»ºè¯·æ±‚ä½“
        const requestBody = {
          jobId: this.jobId,
          needDetail: true
        };
        
        const url = `/api?${queryParams.toString()}`;
        
        const res = await axios.post(url, requestBody);
        const data = res?.data || {};
        
        
        // å¤„ç†ä»»åŠ¡è¯¦æƒ…æ•°æ®
        this.jobDetail = this.processJobDetail(data);
      } catch (e) {
        this.error = 'åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ' + (e.response?.data?.error || e.message || e);
        console.error('Failed to load job detail:', e);
      } finally {
        this.loading = false;
      }
    },
    
    processJobDetail(data) {
      // å°è¯•ä»ä¸åŒçš„å“åº”ç»“æ„ä¸­æå–ä»»åŠ¡è¯¦æƒ…
      const job = data?.result || data?.job || data?.Job || data;
      
      if (!job) {
        throw new Error('æ— æ³•è§£æä»»åŠ¡è¯¦æƒ…æ•°æ®');
      }
      
      return {
        jobId: job.jobId || job.id || job.jobID || '',
        name: job.name || job.jobName || '',
        status: job.status || job.state || job.phase || '',
        jobType: job.jobType || job.type || '',
        priority: job.priority || '',
        queueName: job.queueName || job.queue || '',
        resourcePoolId: job.resourcePoolId || job.resourcePool || '',
        description: job.description || job.desc || '',
        createdAt: job.createdAt || job.createdTime || job.creationTime || '',
        updatedAt: job.updatedAt || job.updatedTime || job.updateTime || '',
        finishedAt: job.finishedAt || job.finishedTime || job.completionTime || '',
        command: job.command || '',
        jobSpec: job.jobSpec || job.spec || {},
        labels: job.labels || [],
        pods: job.pods || job.Pods || job.podList || []
      };
    },
    
    statusText(status) {
      const statusMap = {
        'Pending': 'ç­‰å¾…ä¸­',
        'Running': 'è¿è¡Œä¸­',
        'Succeeded': 'æˆåŠŸ',
        'Failed': 'å¤±è´¥',
        'Cancelled': 'å·²å–æ¶ˆ',
        'ManualTermination': 'æ‰‹åŠ¨ç»ˆæ­¢',
        'Unknown': 'æœªçŸ¥'
      };
      return statusMap[status] || status || 'æœªçŸ¥';
    },
    
    statusClass(status) {
      const classMap = {
        'Pending': 'status-pending',
        'Running': 'status-running',
        'Succeeded': 'status-success',
        'Failed': 'status-error',
        'Cancelled': 'status-cancelled',
        'ManualTermination': 'status-cancelled',
        'Unknown': 'status-unknown'
      };
      return classMap[status] || 'status-unknown';
    },
    
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }
  },
  methods: {
    // æ£€æµ‹æ¥æºé¡µé¢å¹¶è®¾ç½®è¿”å›é“¾æ¥
    detectSourcePage() {
      const urlParams = new URLSearchParams(window.location.search);
      this.fromPage = urlParams.get('from');
      this.datasetId = urlParams.get('datasetId');
      
      if (this.fromPage === 'imports' && this.datasetId) {
        this.backUrl = `/datasets/${this.datasetId}?tab=imports`;
        this.backText = 'â† è¿”å›å¯¼å…¥è®°å½•';
      } else if (this.fromPage === 'jobs') {
        this.backUrl = '/jobs';
        this.backText = 'â† è¿”å›ä»»åŠ¡åˆ—è¡¨';
      } else {
        // é»˜è®¤è¿”å›ä»»åŠ¡åˆ—è¡¨
        this.backUrl = '/jobs';
        this.backText = 'â† è¿”å›ä»»åŠ¡åˆ—è¡¨';
      }
    }
  },
  
  async mounted() {
    // æ£€æµ‹æ¥æºé¡µé¢
    this.detectSourcePage();
    
    // åŠ è½½ä»»åŠ¡è¯¦æƒ…
    await this.loadJobDetail();
  },
  
  methods: {
    // æ£€æµ‹æ¥æºé¡µé¢å¹¶è®¾ç½®è¿”å›é“¾æ¥
    detectSourcePage() {
      const urlParams = new URLSearchParams(window.location.search);
      this.fromPage = urlParams.get('from');
      this.datasetId = urlParams.get('datasetId');
      
      if (this.fromPage === 'imports' && this.datasetId) {
        this.backUrl = `/datasets/${this.datasetId}?tab=imports`;
        this.backText = 'â† è¿”å›å¯¼å…¥è®°å½•';
      } else if (this.fromPage === 'jobs') {
        this.backUrl = '/jobs';
        this.backText = 'â† è¿”å›ä»»åŠ¡åˆ—è¡¨';
      } else {
        // é»˜è®¤è¿”å›ä»»åŠ¡åˆ—è¡¨
        this.backUrl = '/jobs';
        this.backText = 'â† è¿”å›ä»»åŠ¡åˆ—è¡¨';
      }
    },
    
    async loadJobDetail() {
      this.loading = true;
      this.error = null;
      
      try {
        // ä»URLå‚æ•°è·å–jobIdå’ŒresourcePoolId
        const urlParams = new URLSearchParams(window.location.search);
        // ä»URLè·¯å¾„ä¸­æå–jobId: /jobs/job-xxx -> job-xxx
        const pathParts = window.location.pathname.split('/');
        this.jobId = urlParams.get('jobId') || pathParts[pathParts.length - 1];
        
        
        if (!this.jobId) {
          throw new Error('ç¼ºå°‘ä»»åŠ¡IDå‚æ•°');
        }
        
        // è·å–èµ„æºæ± IDï¼ˆä»URLå‚æ•°æˆ–é»˜è®¤å€¼ï¼‰
        const resourcePoolId = urlParams.get('resourcePoolId') || 'aihc-serverless';
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const queryParams = new URLSearchParams({
          action: 'DescribeJob',
          resourcePoolId: resourcePoolId
        });
        
        // æ„å»ºè¯·æ±‚ä½“
        const requestBody = {
          jobId: this.jobId,
          needDetail: true
        };
        
        const url = `/api?${queryParams.toString()}`;
        
        const res = await axios.post(url, requestBody);
        const data = res?.data || {};
        
        
        // å¤„ç†ä»»åŠ¡è¯¦æƒ…æ•°æ®
        this.jobDetail = this.processJobDetail(data);
      } catch (e) {
        this.error = 'åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ' + (e.response?.data?.error || e.message || e);
        console.error('Failed to load job detail:', e);
      } finally {
        this.loading = false;
      }
    },
    
    processJobDetail(data) {
      // å°è¯•ä»ä¸åŒçš„å“åº”ç»“æ„ä¸­æå–ä»»åŠ¡è¯¦æƒ…
      const job = data?.result || data?.job || data?.Job || data;
      
      if (!job) {
        throw new Error('æ— æ³•è§£æä»»åŠ¡è¯¦æƒ…æ•°æ®');
      }
      
      return {
        jobId: job.jobId || job.id || job.jobID || '',
        name: job.name || job.jobName || '',
        status: job.status || job.state || job.phase || '',
        jobType: job.jobType || job.type || '',
        priority: job.priority || '',
        queueName: job.queueName || job.queue || '',
        resourcePoolId: job.resourcePoolId || job.resourcePool || '',
        description: job.description || job.desc || '',
        createdAt: job.createdAt || job.createdTime || job.creationTime || '',
        updatedAt: job.updatedAt || job.updatedTime || job.updateTime || '',
        finishedAt: job.finishedAt || job.finishedTime || job.completionTime || '',
        command: job.command || '',
        jobSpec: job.jobSpec || job.spec || {},
        labels: job.labels || [],
        pods: job.pods || job.Pods || job.podList || []
      };
    },
    
    statusText(status) {
      const statusMap = {
        'Pending': 'ç­‰å¾…ä¸­',
        'Running': 'è¿è¡Œä¸­',
        'Succeeded': 'æˆåŠŸ',
        'Failed': 'å¤±è´¥',
        'Cancelled': 'å·²å–æ¶ˆ',
        'ManualTermination': 'æ‰‹åŠ¨ç»ˆæ­¢',
        'Unknown': 'æœªçŸ¥'
      };
      return statusMap[status] || status || 'æœªçŸ¥';
    },
    
    statusClass(status) {
      const classMap = {
        'Pending': 'status-pending',
        'Running': 'status-running',
        'Succeeded': 'status-success',
        'Failed': 'status-failed',
        'Cancelled': 'status-cancelled',
        'ManualTermination': 'status-cancelled',
        'Unknown': 'status-unknown'
      };
      return classMap[status] || 'status-unknown';
    },
    
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }
  }
}).mount('#app');
</script>
{% endblock %}
