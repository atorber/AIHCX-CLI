{% extends "base.html" %}
{% from "components/navigation.html" import navigation %}

{% block title %}AIHCX ‰ªªÂä°ËØ¶ÊÉÖ{% endblock %}

{% block header_title %}üìã ‰ªªÂä°ËØ¶ÊÉÖ{% endblock %}
{% block header_subtitle %}Êü•ÁúãËÆ≠ÁªÉ‰ªªÂä°ËØ¶ÁªÜ‰ø°ÊÅØ{% endblock %}

{% block extra_css %}
<style>
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .job-card {
        background: var(--panel-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .job-card-header {
        background: #f8f9fa;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .job-card-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
    }
    
    .job-card-body {
        padding: 24px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .info-item {
        margin-bottom: 16px;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    .info-value {
        font-size: 15px;
        color: var(--text);
        word-break: break-all;
    }
    
    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-running {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-cancelled {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .status-unknown {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    
    .error {
        text-align: center;
        padding: 40px;
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    
    .empty-state i {
        font-size: 48px;
        color: #adb5bd;
        margin-bottom: 16px;
    }
    
    .command-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 16px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .labels-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .label-tag {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-family: monospace;
    }
    
    .env-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 16px;
    }
    
    .env-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .env-item:last-child {
        border-bottom: none;
    }
    
    .env-name {
        font-weight: 600;
        color: #495057;
        font-family: monospace;
        font-size: 13px;
    }
    
    .env-value {
        color: var(--text);
        font-family: monospace;
        font-size: 13px;
        word-break: break-all;
        max-width: 60%;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <div class="page-container">
        <!-- Êìç‰ΩúÊ†è -->
        <div class="action-bar">
            <a :href="backUrl" class="btn-back">
                [[ backText ]]
            </a>
        </div>

        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> ‰ªªÂä°ËØ¶ÊÉÖÂä†ËΩΩ‰∏≠...
        </div>

        <!-- ÈîôËØØ‰ø°ÊÅØ -->
        <div v-if="error" class="error">
            <i class="fas fa-exclamation-circle"></i> [[ error ]]
        </div>

        <!-- ‰ªªÂä°ËØ¶ÊÉÖ -->
        <div v-if="jobDetail && !loading && !error">
            <!-- Âü∫Êú¨‰ø°ÊÅØ -->
            <div class="job-card">
                <div class="job-card-header">
                    <h5>Âü∫Êú¨‰ø°ÊÅØ</h5>
                </div>
                <div class="job-card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">‰ªªÂä°ÂêçÁß∞</div>
                            <div class="info-value">[[ jobDetail.name ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‰ªªÂä°ID</div>
                            <div class="info-value">[[ jobDetail.jobId ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Áä∂ÊÄÅ</div>
                            <div class="info-value">
                                <span class="status" :class="statusClass(jobDetail.status)">
                                    [[ statusText(jobDetail.status) ]]
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‰ªªÂä°Á±ªÂûã</div>
                            <div class="info-value">[[ jobDetail.jobType ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‰ºòÂÖàÁ∫ß</div>
                            <div class="info-value">[[ jobDetail.priority ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÈòüÂàó</div>
                            <div class="info-value">[[ jobDetail.queueName ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ËµÑÊ∫êÊ±†ID</div>
                            <div class="info-value">[[ jobDetail.resourcePoolId ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÂàõÂª∫Êó∂Èó¥</div>
                            <div class="info-value">[[ formatDate(jobDetail.createdAt) ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÂÆåÊàêÊó∂Èó¥</div>
                            <div class="info-value">[[ formatDate(jobDetail.finishedAt) ]]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰ªªÂä°ËßÑÊ†º -->
            <div class="job-card" v-if="jobDetail.jobSpec">
                <div class="job-card-header">
                    <h5>‰ªªÂä°ËßÑÊ†º</h5>
                </div>
                <div class="job-card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ÈïúÂÉè</div>
                            <div class="info-value">[[ jobDetail.jobSpec.image ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÂâØÊú¨Êï∞</div>
                            <div class="info-value">[[ jobDetail.jobSpec.replicas ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÂêØÁî®RDMA</div>
                            <div class="info-value">[[ jobDetail.jobSpec.enableRDMA ? 'ÊòØ' : 'Âê¶' ]]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊâßË°åÂëΩ‰ª§ -->
            <div class="job-card" v-if="jobDetail.command">
                <div class="job-card-header">
                    <h5>ÊâßË°åÂëΩ‰ª§</h5>
                </div>
                <div class="job-card-body">
                    <div class="command-container">[[ jobDetail.command ]]</div>
                </div>
            </div>

            <!-- ÁéØÂ¢ÉÂèòÈáè -->
            <div class="job-card" v-if="jobDetail.jobSpec && jobDetail.jobSpec.envs && jobDetail.jobSpec.envs.length > 0">
                <div class="job-card-header">
                    <h5>ÁéØÂ¢ÉÂèòÈáè</h5>
                </div>
                <div class="job-card-body">
                    <div class="env-container">
                        <div class="env-item" v-for="env in jobDetail.jobSpec.envs" :key="env.name">
                            <span class="env-name">[[ env.name ]]</span>
                            <span class="env-value">[[ env.value ]]</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê†áÁ≠æ -->
            <div class="job-card" v-if="jobDetail.labels && jobDetail.labels.length > 0">
                <div class="job-card-header">
                    <h5>Ê†áÁ≠æ</h5>
                </div>
                <div class="job-card-body">
                    <div class="labels-container">
                        <span class="label-tag" v-for="label in jobDetail.labels" :key="label.key">
                            [[ label.key ]]: [[ label.value ]]
                        </span>
                    </div>
                </div>
            </div>

            <!-- Pod‰ø°ÊÅØ -->
            <div class="job-card" v-if="jobDetail.pods && jobDetail.pods.length > 0">
                <div class="job-card-header">
                    <h5>Pod‰ø°ÊÅØ</h5>
                </div>
                <div class="job-card-body">
                    <div v-for="pod in jobDetail.pods" :key="pod.name" style="margin-bottom: 16px;">
                        <div class="info-item">
                            <div class="info-label">PodÂêçÁß∞</div>
                            <div class="info-value">[[ pod.name ]]</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Áä∂ÊÄÅ</div>
                            <div class="info-value">
                                <span class="status" :class="statusClass(pod.status)">
                                    [[ statusText(pod.status) ]]
                                </span>
                            </div>
                        </div>
                        <div class="info-item" v-if="pod.nodeName">
                            <div class="info-label">ËäÇÁÇπ</div>
                            <div class="info-value">[[ pod.nodeName ]]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á©∫Áä∂ÊÄÅ -->
        <div v-if="!loading && !error && !jobDetail" class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Êú™ÊâæÂà∞‰ªªÂä°ËØ¶ÊÉÖ</p>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  delimiters: ['[[', ']]'],
  data() {
    return {
      jobId: null,
      jobDetail: null,
      loading: false,
      error: null,
      fromPage: null,
      datasetId: null,
      backUrl: '/jobs',
      backText: '‚Üê ËøîÂõû‰ªªÂä°ÂàóË°®'
    }
  },
  methods: {
    async loadJobDetail() {
      this.loading = true;
      this.error = null;
      
      try {
        // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñjobIdÂíåresourcePoolId
        const urlParams = new URLSearchParams(window.location.search);
        // ‰ªéURLË∑ØÂæÑ‰∏≠ÊèêÂèñjobId: /jobs/job-xxx -> job-xxx
        const pathParts = window.location.pathname.split('/');
        this.jobId = urlParams.get('jobId') || pathParts[pathParts.length - 1];
        
        
        if (!this.jobId) {
          throw new Error('Áº∫Â∞ë‰ªªÂä°IDÂèÇÊï∞');
        }
        
        // Ëé∑ÂèñËµÑÊ∫êÊ±†IDÔºà‰ªéURLÂèÇÊï∞ÊàñÈªòËÆ§ÂÄºÔºâ
        const resourcePoolId = urlParams.get('resourcePoolId') || 'aihc-serverless';
        
        // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
        const queryParams = new URLSearchParams({
          action: 'DescribeJob',
          resourcePoolId: resourcePoolId
        });
        
        // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
        const requestBody = {
          jobId: this.jobId,
          needDetail: true
        };
        
        const url = `/api?${queryParams.toString()}`;
        
        const res = await axios.post(url, requestBody);
        const data = res?.data || {};
        
        
        // Â§ÑÁêÜ‰ªªÂä°ËØ¶ÊÉÖÊï∞ÊçÆ
        this.jobDetail = this.processJobDetail(data);
      } catch (e) {
        this.error = 'Âä†ËΩΩ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•: ' + (e.response?.data?.error || e.message || e);
        console.error('Failed to load job detail:', e);
      } finally {
        this.loading = false;
      }
    },
    
    processJobDetail(data) {
      // Â∞ùËØï‰ªé‰∏çÂêåÁöÑÂìçÂ∫îÁªìÊûÑ‰∏≠ÊèêÂèñ‰ªªÂä°ËØ¶ÊÉÖ
      const job = data?.result || data?.job || data?.Job || data;
      
      if (!job) {
        throw new Error('Êó†Ê≥ïËß£Êûê‰ªªÂä°ËØ¶ÊÉÖÊï∞ÊçÆ');
      }
      
      return {
        jobId: job.jobId || job.id || job.jobID || '',
        name: job.name || job.jobName || '',
        status: job.status || job.state || job.phase || '',
        jobType: job.jobType || job.type || '',
        priority: job.priority || '',
        queueName: job.queueName || job.queue || '',
        resourcePoolId: job.resourcePoolId || job.resourcePool || '',
        description: job.description || job.desc || '',
        createdAt: job.createdAt || job.createdTime || job.creationTime || '',
        updatedAt: job.updatedAt || job.updatedTime || job.updateTime || '',
        finishedAt: job.finishedAt || job.finishedTime || job.completionTime || '',
        command: job.command || '',
        jobSpec: job.jobSpec || job.spec || {},
        labels: job.labels || [],
        pods: job.pods || job.Pods || job.podList || []
      };
    },
    
    statusText(status) {
      const statusMap = {
        'Pending': 'Á≠âÂæÖ‰∏≠',
        'Running': 'ËøêË°å‰∏≠',
        'Succeeded': 'ÊàêÂäü',
        'Failed': 'Â§±Ë¥•',
        'Cancelled': 'Â∑≤ÂèñÊ∂à',
        'ManualTermination': 'ÊâãÂä®ÁªàÊ≠¢',
        'Unknown': 'Êú™Áü•'
      };
      return statusMap[status] || status || 'Êú™Áü•';
    },
    
    statusClass(status) {
      const classMap = {
        'Pending': 'status-pending',
        'Running': 'status-running',
        'Succeeded': 'status-success',
        'Failed': 'status-error',
        'Cancelled': 'status-cancelled',
        'ManualTermination': 'status-cancelled',
        'Unknown': 'status-unknown'
      };
      return classMap[status] || 'status-unknown';
    },
    
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }
  },
  methods: {
    // Ê£ÄÊµãÊù•Ê∫êÈ°µÈù¢Âπ∂ËÆæÁΩÆËøîÂõûÈìæÊé•
    detectSourcePage() {
      const urlParams = new URLSearchParams(window.location.search);
      this.fromPage = urlParams.get('from');
      this.datasetId = urlParams.get('datasetId');
      
      if (this.fromPage === 'imports' && this.datasetId) {
        this.backUrl = `/datasets/${this.datasetId}?tab=imports`;
        this.backText = '‚Üê ËøîÂõûÂØºÂÖ•ËÆ∞ÂΩï';
      } else if (this.fromPage === 'jobs') {
        this.backUrl = '/jobs';
        this.backText = '‚Üê ËøîÂõû‰ªªÂä°ÂàóË°®';
      } else {
        // ÈªòËÆ§ËøîÂõû‰ªªÂä°ÂàóË°®
        this.backUrl = '/jobs';
        this.backText = '‚Üê ËøîÂõû‰ªªÂä°ÂàóË°®';
      }
    }
  },
  
  async mounted() {
    // Ê£ÄÊµãÊù•Ê∫êÈ°µÈù¢
    this.detectSourcePage();
    
    // Âä†ËΩΩ‰ªªÂä°ËØ¶ÊÉÖ
    await this.loadJobDetail();
  },
  
  methods: {
    // Ê£ÄÊµãÊù•Ê∫êÈ°µÈù¢Âπ∂ËÆæÁΩÆËøîÂõûÈìæÊé•
    detectSourcePage() {
      const urlParams = new URLSearchParams(window.location.search);
      this.fromPage = urlParams.get('from');
      this.datasetId = urlParams.get('datasetId');
      
      if (this.fromPage === 'imports' && this.datasetId) {
        this.backUrl = `/datasets/${this.datasetId}?tab=imports`;
        this.backText = '‚Üê ËøîÂõûÂØºÂÖ•ËÆ∞ÂΩï';
      } else if (this.fromPage === 'jobs') {
        this.backUrl = '/jobs';
        this.backText = '‚Üê ËøîÂõû‰ªªÂä°ÂàóË°®';
      } else {
        // ÈªòËÆ§ËøîÂõû‰ªªÂä°ÂàóË°®
        this.backUrl = '/jobs';
        this.backText = '‚Üê ËøîÂõû‰ªªÂä°ÂàóË°®';
      }
    },
    
    async loadJobDetail() {
      this.loading = true;
      this.error = null;
      
      try {
        // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñjobIdÂíåresourcePoolId
        const urlParams = new URLSearchParams(window.location.search);
        // ‰ªéURLË∑ØÂæÑ‰∏≠ÊèêÂèñjobId: /jobs/job-xxx -> job-xxx
        const pathParts = window.location.pathname.split('/');
        this.jobId = urlParams.get('jobId') || pathParts[pathParts.length - 1];
        
        
        if (!this.jobId) {
          throw new Error('Áº∫Â∞ë‰ªªÂä°IDÂèÇÊï∞');
        }
        
        // Ëé∑ÂèñËµÑÊ∫êÊ±†IDÔºà‰ªéURLÂèÇÊï∞ÊàñÈªòËÆ§ÂÄºÔºâ
        const resourcePoolId = urlParams.get('resourcePoolId') || 'aihc-serverless';
        
        // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
        const queryParams = new URLSearchParams({
          action: 'DescribeJob',
          resourcePoolId: resourcePoolId
        });
        
        // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
        const requestBody = {
          jobId: this.jobId,
          needDetail: true
        };
        
        const url = `/api?${queryParams.toString()}`;
        
        const res = await axios.post(url, requestBody);
        const data = res?.data || {};
        
        
        // Â§ÑÁêÜ‰ªªÂä°ËØ¶ÊÉÖÊï∞ÊçÆ
        this.jobDetail = this.processJobDetail(data);
      } catch (e) {
        this.error = 'Âä†ËΩΩ‰ªªÂä°ËØ¶ÊÉÖÂ§±Ë¥•: ' + (e.response?.data?.error || e.message || e);
        console.error('Failed to load job detail:', e);
      } finally {
        this.loading = false;
      }
    },
    
    processJobDetail(data) {
      // Â∞ùËØï‰ªé‰∏çÂêåÁöÑÂìçÂ∫îÁªìÊûÑ‰∏≠ÊèêÂèñ‰ªªÂä°ËØ¶ÊÉÖ
      const job = data?.result || data?.job || data?.Job || data;
      
      if (!job) {
        throw new Error('Êó†Ê≥ïËß£Êûê‰ªªÂä°ËØ¶ÊÉÖÊï∞ÊçÆ');
      }
      
      return {
        jobId: job.jobId || job.id || job.jobID || '',
        name: job.name || job.jobName || '',
        status: job.status || job.state || job.phase || '',
        jobType: job.jobType || job.type || '',
        priority: job.priority || '',
        queueName: job.queueName || job.queue || '',
        resourcePoolId: job.resourcePoolId || job.resourcePool || '',
        description: job.description || job.desc || '',
        createdAt: job.createdAt || job.createdTime || job.creationTime || '',
        updatedAt: job.updatedAt || job.updatedTime || job.updateTime || '',
        finishedAt: job.finishedAt || job.finishedTime || job.completionTime || '',
        command: job.command || '',
        jobSpec: job.jobSpec || job.spec || {},
        labels: job.labels || [],
        pods: job.pods || job.Pods || job.podList || []
      };
    },
    
    statusText(status) {
      const statusMap = {
        'Pending': 'Á≠âÂæÖ‰∏≠',
        'Running': 'ËøêË°å‰∏≠',
        'Succeeded': 'ÊàêÂäü',
        'Failed': 'Â§±Ë¥•',
        'Cancelled': 'Â∑≤ÂèñÊ∂à',
        'ManualTermination': 'ÊâãÂä®ÁªàÊ≠¢',
        'Unknown': 'Êú™Áü•'
      };
      return statusMap[status] || status || 'Êú™Áü•';
    },
    
    statusClass(status) {
      const classMap = {
        'Pending': 'status-pending',
        'Running': 'status-running',
        'Succeeded': 'status-success',
        'Failed': 'status-failed',
        'Cancelled': 'status-cancelled',
        'ManualTermination': 'status-cancelled',
        'Unknown': 'status-unknown'
      };
      return classMap[status] || 'status-unknown';
    },
    
    formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }
  }
}).mount('#app');
</script>
{% endblock %}
